<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Device Configuration Generator - Schneider Electric</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .main-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: #3dcd68;
      color: white;
      padding: 20px;
    }

    .container {
      flex: 1;
      padding: 20px;
      background: white;
      margin: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header {
      margin-bottom: 30px;
    }

    .header h1 {
      color: #3dcd68;
      margin-bottom: 20px;
    }

    .config-section {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .config-section h3 {
      color: #3dcd68;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 20px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #3dcd68;
    }

    .config-cards {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
    }

    .config-card {
      flex: 1;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .config-card:hover {
      border-color: #3dcd68;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    }

    .config-card h4 {
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .config-card p {
      color: #666;
      font-size: 0.9rem;
      margin: 0;
    }

    .protocol-selection {
      background: #e8f5e8;
      border: 3px solid #3dcd68;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      text-align: center;
    }

    .protocol-selection h2 {
      color: #2d7a3d;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 24px 0;
    }

    .protocol-buttons {
      display: flex;
      gap: 24px;
      justify-content: center;
      margin-top: 24px;
    }

    .protocol-btn {
      flex: 1;
      max-width: 200px;
      background: white;
      border: 3px solid #3dcd68;
      border-radius: 12px;
      padding: 24px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 600;
      color: #3dcd68;
    }

    .protocol-btn:hover {
      background: #3dcd68;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.25);
    }

    .protocol-btn.active {
      background: #3dcd68;
      color: white;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      position: relative;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-icon {
      width: 18px;
      height: 18px;
      background: #3dcd68;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: help;
      position: relative;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      background: #2db555;
    }

    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      max-width: 300px;
      min-width: 180px;
      white-space: normal;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      pointer-events: none;
      text-align: left;
      border: 1px solid #555;
      top: 25px;
      left: 50%;
      transform: translateX(-50%);
    }

    .tooltip::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #333;
    }

    .info-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    .hidden {
      display: none !important;
    }

    .file-input-label {
      display: inline-block;
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-right: 10px;
      font-weight: 600;
    }

    .file-input-label:hover {
      background: #0056b3;
    }

    .file-input {
      display: none;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-secondary {
      background: #007bff;
      color: white;
    }

    .btn-secondary:hover {
      background: #007bff;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .button-group {
      display: flex;
      gap: 16px;
      margin-top: 24px;
      align-items: center;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin: 24px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3dcd68, #28a745);
      width: 0%;
      transition: width 0.3s ease;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3dcd68;
      box-shadow: 0 0 0 3px rgba(61, 205, 104, 0.1);
    }

    input:disabled, select:disabled, textarea:disabled {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3dcd68;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active, .tab:hover {
      color: #3dcd68;
      border-bottom-color: #3dcd68;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .alert {
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .file-upload-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
    }

    .file-upload-section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 1.1rem;
    }

    .file-upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .data-table th {
      background: #f8f9fa;
      padding: 12px;
      border: 1px solid #dee2e6;
      text-align: left;
      font-weight: 600;
      color: #333;
    }

    .data-table td {
      padding: 12px;
      border: 1px solid #dee2e6;
      position: relative;
    }

    /* Enhanced editable cell styles */
    .editable-cell {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      width: 100%;
      padding: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .editable-cell:hover {
      border-color: #3dcd68;
      background: #f8fff9;
    }

    .editable-cell:focus {
      background: #fff3cd;
      border-color: #ffc107;
      box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.25);
      outline: none;
    }

    .editable-select {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      width: 100%;
      padding: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      box-sizing: border-box;
      cursor: pointer;
    }

    .editable-select:hover {
      border-color: #3dcd68;
      background: #f8fff9;
    }

    .editable-select:focus {
      background: #fff3cd;
      border-color: #ffc107;
      box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.25);
      outline: none;
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }

    .modbus-variant-selection {
      background: #e8f4fd;
      border: 2px solid #007bff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .modbus-variant-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 16px;
    }

    .modbus-variant-btn {
      flex: 1;
      max-width: 150px;
      background: white;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 600;
      color: #007bff;
      text-align: center;
    }

    .modbus-variant-btn:hover {
      background: #007bff;
      color: white;
    }

    .modbus-variant-btn.active {
      background: #007bff;
      color: white;
    }

    .advanced-options-toggle {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .advanced-options-toggle:hover {
      background: #e9ecef;
    }

    .checkbox-container {
      position: relative;
      display: inline-block;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
    }

    .advanced-options-toggle label {
      margin: 0;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #495057;
    }

    .advanced-options-content {
      transition: all 0.3s ease;
      opacity: 0.5;
      pointer-events: none;
    }

    .advanced-options-content.enabled {
      opacity: 1;
      pointer-events: all;
    }

    .editing-row {
      background-color: rgba(255, 193, 7, 0.1) !important;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      padding: 4px 8px;
      font-size: 0.8rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .editable-row:hover {
      background-color: rgba(61, 205, 104, 0.05);
    }

    .row-changed {
      background-color: rgba(255, 193, 7, 0.1);
    }

    .row-changed .editable-cell,
    .row-changed .editable-select {
      background-color: rgba(255, 193, 7, 0.05);
    }

    @media (max-width: 768px) {
      .config-cards {
        flex-direction: column;
      }

      .protocol-buttons {
        flex-direction: column;
      }

      .form-grid-2, .form-grid-3 {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .file-upload-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar">
      <h3>Saved Devices <span class="device-counter" id="deviceCounter">0</span></h3>
      <div class="device-list" id="deviceList">
        <div class="placeholder-content">
          <p>No devices configured yet.</p>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>Device Configuration Generator</h1>

          <div class="file-upload-section">
            <h3>File Upload</h3>
            <div class="file-upload-grid">
              <div>
                <input type="file" id="csvFile" class="file-input" accept=".csv" />
                <label for="csvFile" class="file-input-label">Load CSV</label>
              </div>
              <div>
                <input type="file" id="variablesCsvFile" class="file-input" accept=".csv" />
                <label for="variablesCsvFile" class="file-input-label">Load Variables CSV</label>
              </div>
              <div>
                <input type="file" id="alarmsCsvFile" class="file-input" accept=".csv" />
                <label for="alarmsCsvFile" class="file-input-label">Load Alarms CSV</label>
              </div>
              <div>
                <input type="file" id="trendsCsvFile" class="file-input" accept=".csv" />
                <label for="trendsCsvFile" class="file-input-label">Load Trends CSV</label>
              </div>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" onclick="showTab('device-info', event)">Device Info</button>
            <button class="tab" onclick="showTab('variables', event)">Variables</button>
            <button class="tab" onclick="showTab('alarms', event)">Alarms</button>
            <button class="tab" onclick="showTab('trends', event)">Trends</button>
          </div>
        </div>
      </div>

      <div class="tab-content active" id="device-info">
        <div class="protocol-selection">
          <h2>Select Communication Protocol</h2>
          <p>Choose the communication protocol that will be used for this device configuration</p>
          <div class="protocol-buttons">
            <button class="protocol-btn active" onclick="selectProtocol('modbus')">
              <div>Modbus</div>
            </button>
            <button class="protocol-btn" onclick="selectProtocol('iec')">
              <div>IEC 61850</div>
            </button>
          </div>
        </div>

        <form id="deviceForm">
          <div class="config-cards">
            <div class="config-card" onclick="generateEquipmentConfig()">
              <h4>Equipment Config</h4>
              <p>Generate EQUIP.csv with device specifications</p>
            </div>
            <div class="config-card" onclick="generateUnitsConfig()">
              <h4>Units Config</h4>
              <p>Generate UNITS.csv with network settings</p>
            </div>
          </div>

          <div class="config-section">
            <h3>Device Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="device_name">
                  Device Name
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Enter a unique device name. Use only letters, numbers, and underscores. Example: PV_Panel_01, Wind_Turbine_07
                    </div>
                  </div>
                </label>
                <input type="text" name="device_name" id="device_name" required placeholder="e.g. PV_Panel_01" />
              </div>

              <div class="form-group">
                <label for="device_type">
                  Device Type
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Select the device type from the list. This determines which variables and configurations will be available for this device.
                    </div>
                  </div>
                </label>
                <select name="device_type" id="device_type" required>
                  <option value="">Select device type</option>
                  <option value="PV">PV Panel</option>
                  <option value="WindTurbine">Wind Turbine</option>
                  <option value="FuelTurbine">Fuel Turbine</option>
                  <option value="FuelCell">Fuel Cell</option>
                  <option value="BESS">BESS</option>
                </select>
              </div>

              <div class="form-group">
                <label for="tag_prefix">
                  Tag Prefix
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Prefix used for all tags of this device. Should be short and unique. Example: FugaPV1, BESS01
                    </div>
                  </div>
                </label>
                <input type="text" name="tag_prefix" id="tag_prefix" required placeholder="e.g. FugaPV1" />
              </div>

              <div class="form-group">
                <label for="io_device">
                  I/O Device
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Name of the physical I/O device or inverter to which the device is connected. Example: Inverter_PV1
                    </div>
                  </div>
                </label>
                <input type="text" name="io_device" id="io_device" required placeholder="e.g. Inverter_PV1" />
              </div>
            </div>
          </div>

          <div class="config-section" id="modbus-config">
            <h3>Modbus Network Configuration</h3>

            <div class="modbus-variant-selection">
              <h4 style="margin: 0 0 10px 0; color: #007bff;">Select Modbus Variant</h4>
              <p style="margin: 0 0 16px 0; color: #666; font-size: 0.9rem;">Choose between TCP/IP or RTU communication</p>
              <div class="modbus-variant-buttons">
                <button type="button" class="modbus-variant-btn active" onclick="selectModbusVariant('tcp')">
                  TCP/IP
                </button>
                <button type="button" class="modbus-variant-btn" onclick="selectModbusVariant('rtu')">
                  RTU
                </button>
              </div>
            </div>

            <div id="modbus-tcp-config">
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="device_ip">
                    Device IP Address
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        IP address of the device on the network. Must be in IPv4 format (e.g. 192.168.1.100). Make sure the address is unique on the network.
                      </div>
                    </div>
                  </label>
                  <input type="text" name="device_ip" id="device_ip" required placeholder="e.g. 192.168.1.100" />
                </div>

                <div class="form-group">
                  <label for="modbus_port">
                    Modbus TCP Port
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        TCP port for Modbus communication. Standard port is 502.
                      </div>
                    </div>
                  </label>
                  <select name="modbus_port" id="modbus_port" required>
                    <option value="502">502</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="port_name">
                    Port Name
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Communication port name in the SCADA system. Example: P14_BOARD1_PRJ3
                      </div>
                    </div>
                  </label>
                  <input type="text" name="port_name" id="port_name" placeholder="e.g. P14_BOARD1_PRJ3" />
                </div>

                <div class="form-group">
                  <label for="memory_tcp">
                    MEMORY
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        TRUE/FALSE
                      </div>
                    </div>
                  </label>
                  <select id="memory_tcp" name="memory">
                    <option value="TRUE">TRUE</option>
                    <option value="FALSE">FALSE</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="modbus-rtu-config" class="hidden">
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="gateway_address">
                    Gateway Address
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Gateway address of the device on the network.
                      </div>
                    </div>
                  </label>
                  <input type="text" name="gateway_address" id="gateway_address" placeholder="e.g. 192.168.1.100" />
                </div>

                <div class="form-group">
                  <label for="slave_id">
                    Slave ID
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                         Modbus RTU slave address (1-247). Each device on the serial bus must have a unique slave ID.
                      </div>
                    </div>
                  </label>
                  <input type="number" name="slave_id" id="slave_id" placeholder="7" min="1" max="247" />
                </div>

                <div class="form-group">
                  <label for="port_name_rtu">
                    Port Name
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Communication port name in the SCADA system. Example: P14_BOARD1_PRJ3
                      </div>
                    </div>
                  </label>
                  <input type="text" name="port_name_rtu" id="port_name_rtu" placeholder="e.g. P14_BOARD1_PRJ3" />
                </div>

                <div class="form-group">
                  <label for="memory_rtu">
                    MEMORY
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        TRUE/FALSE
                      </div>
                    </div>
                  </label>
                  <select id="memory_rtu" name="memory_rtu">
                    <option value="TRUE">TRUE</option>
                    <option value="FALSE">FALSE</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="serial_port">
                    Serial Port
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Serial communication port (e.g. COM1, COM2, /dev/ttyS0). This is the physical port on the computer or gateway.
                      </div>
                    </div>
                  </label>
                  <input type="text" name="serial_port" id="serial_port" placeholder="e.g. COM1" />
                </div>
              </div>

              <div class="advanced-options-toggle" onclick="toggleAdvancedOptions()">
                <div class="checkbox-container">
                  <input type="checkbox" id="advancedOptionsCheckbox">
                </div>
                <label for="advancedOptionsCheckbox">Advanced Options</label>
              </div>

              <div id="advancedOptionsContent" class="advanced-options-content">
                <div class="form-grid-2">
                  <div class="form-group">
                    <label for="baud_rate">
                      Baud Rate
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Serial communication speed in bits per second. Common values: 9600, 19200, 38400, 57600, 115200.
                        </div>
                      </div>
                    </label>
                    <select name="baud_rate" id="baud_rate" disabled>
                      <option value="9600">9600</option>
                      <option value="19200">19200</option>
                      <option value="38400" selected>38400</option>
                      <option value="57600">57600</option>
                      <option value="115200">115200</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="data_bits">
                      Data Bits
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Number of data bits per character. Standard is 8 bits.
                        </div>
                      </div>
                    </label>
                    <select name="data_bits" id="data_bits" disabled>
                      <option value="7">7</option>
                      <option value="8" selected>8</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="parity">
                      Parity
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Error checking method. None = no parity, Even = even parity, Odd = odd parity.
                        </div>
                      </div>
                    </label>
                    <select name="parity" id="parity" disabled>
                      <option value="None" selected>None</option>
                      <option value="Even">Even</option>
                      <option value="Odd">Odd</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="stop_bits">
                      Stop Bits
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Number of stop bits. Standard is 1 stop bit.
                        </div>
                      </div>
                    </label>
                    <select name="stop_bits" id="stop_bits" disabled>
                      <option value="1" selected>1</option>
                      <option value="2">2</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="protocol">
                Protocol
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Communication protocol used to connect to the device.
                  </div>
                </div>
              </label>
              <select name="protocol" id="protocol" required>
                <option value="Modbus TCP">Modbus TCP/IP</option>
              </select>
            </div>
          </div>

          <div class="config-section hidden" id="iec-config">
            <h3>IEC 61850 Network Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="iec_device_ip">
                  Device IP Address
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      IP address of the IEC 61850 device. Must be in IPv4 format (e.g. 192.168.1.100). Ensure unique addressing on the substation network.
                    </div>
                  </div>
                </label>
                <input type="text" name="iec_device_ip" id="iec_device_ip" placeholder="e.g. 192.168.1.100" />
              </div>

              <div class="form-group">
                <label for="iec_port">
                  IEC Port
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      TCP port for IEC 61850 communication. Standard port is 102 for MMS services. Can be customized if needed.
                    </div>
                  </div>
                </label>
                <input type="number" name="iec_port" id="iec_port" placeholder="102" value="102" min="1" max="65535" />
              </div>

              <div class="form-group">
                <label for="ied_name">
                  IED Name
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Intelligent Electronic Device name as defined in the SCL configuration. Must match the IED name in the substation configuration file.
                    </div>
                  </div>
                </label>
                <input type="text" name="ied_name" id="ied_name" placeholder="e.g. PROT_RELAY_01" />
              </div>

              <div class="form-group">
                <label for="access_point">
                  Access Point
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Access Point name for the IED communication interface. Typically defined in the IED configuration (e.g. S1, AP1, ETH1).
                    </div>
                  </div>
                </label>
                <input type="text" name="access_point" id="access_point" placeholder="e.g. S1" />
              </div>

              <div class="form-group">
                <label for="logical_device">
                  Logical Device
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Logical Device name within the IED. Represents a logical grouping of functions (e.g. LD0, PROT, CTRL).
                    </div>
                  </div>
                </label>
                <input type="text" name="logical_device" id="logical_device" placeholder="e.g. LD0" />
              </div>

              <div class="form-group">
                <label for="report_control">
                  Report Control Block
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Name of the Report Control Block (RCB) for data reporting. Used for unbuffered or buffered reporting of data changes and events.
                    </div>
                  </div>
                </label>
                <input type="text" name="report_control" id="report_control" placeholder="e.g. brcb01" />
              </div>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>

          <div class="button-group">
            <input type="file" id="cidFile" class="file-input hidden" accept=".cid" />
            <label for="cidFile" class="file-input-label hidden" id="cidInputLabel">Load CID</label>

            <button type="button" class="btn btn-success" id="saveDeviceBtn" onclick="saveDevice()">Save Device</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
            <button type="button" class="btn btn-primary" id="generateCSVBtn" onclick="generateCSV()">Generate CSV Files</button>
          </div>
        </form>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Generating configuration files</p>
        </div>
      </div>

       <div class="tab-content" id="variables">
        <div class="config-section">
          <h3>Variable Configuration</h3>
          <div class="form-grid-3">
            <div class="form-group">
              <label for="item_name">
                Item Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Short item identifier for the variable (e.g. Ia, Vab, P, Q, F, Temp01). Should be unique and descriptive.
                  </div>
                </div>
              </label>
              <input type="text" id="item_name" placeholder="e.g. Ia" />
            </div>

            <div class="form-group">
              <label for="io_device_var">
                I/O Device
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Name of the I/O device or communication interface where this variable is connected (e.g. Inverter_01, PLC_Main).
                  </div>
                </div>
              </label>
              <input type="text" id="io_device_var" placeholder="e.g. Inverter_01" />
            </div>

            <div class="form-group">
              <label for="tag_name_var">
                Tag Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Full tag name including logical node and data object (IEC 61850 format: MMXU1\A\phsA or Modbus register reference).
                  </div>
                </div>
              </label>
              <input type="text" id="tag_name_var" placeholder="e.g. MMXU1\A\phsA" />
            </div>

            <div class="form-group">
              <label for="address">
                Address
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Register address or memory location where the variable is stored (e.g. 40001, 30001 for Modbus registers).
                  </div>
                </div>
              </label>
              <input type="text" id="address" placeholder="e.g. 40001" />
            </div>

            <div class="form-group">
              <label for="equipment_var">
                Equipment
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Equipment hierarchy path where this variable belongs (e.g. Site.Building.Device, Virtual.System).
                  </div>
                </div>
              </label>
              <input type="text" id="equipment_var" placeholder="e.g. Virtual.System" />
            </div>

            <div class="form-group">
              <label for="data_type">
                Data Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Data type: Float (floating point numbers), Integer (whole numbers), Boolean (true/false), String (text).
                  </div>
                </div>
              </label>
              <select id="data_type">
                <option value="float">Float</option>
                <option value="int">Integer</option>
                <option value="bool">Boolean</option>
                <option value="string">String</option>
              </select>
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" id="addVariableBtn" onclick="addVariable()">Add Variable</button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Item Name</th>
                <th>I/O Device</th>
                <th>Tag Name</th>
                <th>Address</th>
                <th>Equipment</th>
                <th>Data Type</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="variableTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="alarms">
        <div class="config-section">
          <h3>Alarms Configuration</h3>
          <div class="form-grid-3">
            <div class="form-group">
              <label for="alarm_name">
                Alarm Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Name for the alarm. Use clear naming convention like PowerFailure24V, HighTemperature, CommLoss
                  </div>
                </div>
              </label>
              <input type="text" id="alarm_name" placeholder="e.g. PowerFailure24V" />
            </div>

            <div class="form-group">
              <label for="alarm_type">
                Alarm Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Alarm type: Analog, Digital, Advanced
                  </div>
                </div>
              </label>
              <select id="alarm_type">
                <option value="analog">Analog</option>
                <option value="digital">Digital</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>

            <div class="form-group">
              <label for="category">
                Category
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Priority level: Low (informational), Medium (warning), High (critical), Event (status change)
                  </div>
                </div>
              </label>
              <select id="category">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="event">Event</option>
              </select>
            </div>

            <div class="form-group">
              <label for="alarm_tag">
                Alarm Tag
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Tag name associated with the alarm. Links alarm to specific data point or signal.
                  </div>
                </div>
              </label>
              <input type="text" id="alarm_tag" placeholder="e.g. User_Event" />
            </div>

            <div class="form-group">
              <label for="equipment">
                Equipment
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Equipment hierarchy path. Defines where the alarm belongs in the system structure.
                  </div>
                </div>
              </label>
              <input type="text" id="equipment" placeholder="e.g. Virtual.System" />
            </div>

            <div class="form-group">
              <label for="item_name_alarm">
                Item Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Specific item name that triggers the alarm (e.g. CommHealth, Temperature, Voltage)
                  </div>
                </div>
              </label>
              <input type="text" id="item_name_alarm" placeholder="e.g. CommHealth" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" id="addAlarmBtn" onclick="addAlarm()">Add Alarm</button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Alarm Name</th>
                <th>Type</th>
                <th>Category</th>
                <th>Alarm Tag</th>
                <th>Equipment</th>
                <th>Item Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="alarmTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="trends">
        <div class="config-section">
          <h3>Trends Configuration</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label for="tag_description">
                Tag Description
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Text for the trend tag. Should clearly identify what is being trended (e.g. "Phase A Current", "Active Power Output").
                  </div>
                </div>
              </label>
              <input type="text" id="tag_description" placeholder="e.g. Current A" />
            </div>

            <div class="form-group">
              <label for="trend_types">
                Trend Types
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Trend collection type: Event (on change), Periodic (time-based), Periodic-Event (both time and change based)
                  </div>
                </div>
              </label>
              <select id="trend_types">
                <option value="event">Event</option>
                <option value="periodic">Periodic</option>
                <option value="periodic-event">Periodic-Event</option>
              </select>
            </div>

              <div class="form-group">
              <label for="trend_time">
                Time
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Time
                  </div>
                </div>
              </label>
              <select id="trend_time">
                <option value="event">1 minute</option>
                <option value="periodic">15 minutes</option>
                <option value="periodic-event">1 hour</option>
              </select>
            </div>

            <div class="form-group">
              <label for="tag_name">
                Tag Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Full tag name path including logical node and data object (IEC 61850 format: MMXU1\A\phsA)
                  </div>
                </div>
              </label>
              <input type="text" id="tag_name" placeholder="e.g. PV4" />
            </div>

            <div class="form-group">
              <label for="item_name_trend">
                Item Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Short item identifier for the trending parameter (e.g. Ia, Vab, P, Q, F)
                  </div>
                </div>
              </label>
              <input type="text" id="item_name_trend" placeholder="e.g. PVPanel4" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" id="addTrendBtn" onclick="addTrend()">Add Trend</button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Tag Description</th>
                <th>Trend Types</th>
                <th>Tag Name</th>
                <th>Item Name</th>
                  <th>Time</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="trendTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>



<script>


let currentProtocol = 'modbus';
let currentModbusVariant = 'tcp';
let devices = [];
let variables = [];
let alarms = [];
let trends = [];
let currentDevice = null;
let validationErrors = {};


const validationRules = {
    device_name: { required: true, minLength: 2, maxLength: 50, pattern: /^[a-zA-Z_][a-zA-Z0-9_-]*$/, message: 'Device name must start with letter/underscore, 2-50 chars, alphanumeric only' },
    device_type: { required: true, message: 'Please select a device type' },
    tag_prefix: { required: true, minLength: 1, maxLength: 10, pattern: /^[A-Z_][A-Z0-9_]*$/, message: 'Tag prefix must start with uppercase letter/underscore' },
    io_device: { required: true, message: 'Please select an I/O device' },
    device_ip: { required: true, pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/, message: 'Enter valid IP address' },
    modbus_port: { required: true, min: 1, max: 65535, message: 'Port must be 1-65535' },
    port_name: { required: true, minLength: 1, maxLength: 20, message: 'Port name required (1-20 chars)' },
    unit_number: { required: true, min: 1, max: 247, message: 'Unit number must be 1-247' },
    gateway_address: { required: true, pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/, message: 'Enter valid gateway IP' },
    slave_id: { required: true, min: 1, max: 247, message: 'Slave ID must be 1-247' },
    serial_port: { required: true, pattern: /^COM\d+$|^\/dev\/tty[A-Za-z0-9]+$/, message: 'Enter valid serial port' },
    iec_device_ip: { required: true, pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/, message: 'Enter valid IEC IP' },
    iec_port: { required: true, min: 1, max: 65535, message: 'IEC port must be 1-65535' },
    ied_name: { required: true, minLength: 1, maxLength: 64, pattern: /^[a-zA-Z_][a-zA-Z0-9_]*$/, message: 'IED name must start with letter/underscore' },
    access_point: { required: true, minLength: 1, maxLength: 32, message: 'Access point required (1-32 chars)' },
    logical_device: { required: true, minLength: 1, maxLength: 64, message: 'Logical device required (1-64 chars)' },

    item_name: { required: true, minLength: 1, maxLength: 30, pattern: /^[a-zA-Z_][a-zA-Z0-9_]*$/, message: 'Item name must start with letter/underscore' },
    io_device_var: { required: true, minLength: 1, maxLength: 50, message: 'I/O Device required' },
    tag_name_var: { required: true, minLength: 1, maxLength: 100, message: 'Tag name required' },
    address: { required: true, minLength: 1, maxLength: 20, message: 'Address required' },
    equipment_var: { required: true, minLength: 1, maxLength: 50, message: 'Equipment required' },
    data_type: { required: true, message: 'Select data type' },

    alarm_name: { required: true, minLength: 1, maxLength: 50, pattern: /^[a-zA-Z_][a-zA-Z0-9_\s]*$/, message: 'Alarm name must start with letter/underscore' },
    alarm_type: { required: true, message: 'Select alarm type' },
    category: { required: true, message: 'Select category' },
    alarm_tag: { required: true, minLength: 1, maxLength: 30, message: 'Alarm tag required' },
    equipment: { required: true, minLength: 1, maxLength: 30, message: 'Equipment required' },
    item_name_alarm: { required: true, minLength: 1, maxLength: 30, message: 'Item name required' },

    tag_description: { required: true, minLength: 3, maxLength: 100, message: 'Tag description 3-100 chars' },
    trend_types: { required: true, message: 'Select trend type' },
    tag_name: { required: true, minLength: 1, maxLength: 50, message: 'Tag name required' },
    item_name_trend: { required: true, minLength: 1, maxLength: 30, message: 'Item name required' }
};


document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    updateDeviceCounter();
    setupValidation();
    setupFileHandlers();
});

function initializeForm() {
    selectProtocol('modbus');
    selectModbusVariant('tcp');
    const advancedCheckbox = document.getElementById('advancedOptionsCheckbox');
    if (advancedCheckbox) {
        advancedCheckbox.checked = false;
        toggleAdvancedOptions();
    }
}

function setupFileHandlers() {
    const handlers = [
        ['csvFile', loadCSV],
        ['variablesCsvFile', loadVariablesCSV],
        ['alarmsCsvFile', loadAlarmsCSV],
        ['trendsCsvFile', loadTrendsCSV],
        ['cidFile', loadCID]
    ];
    handlers.forEach(([id, handler]) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', handler);
    });
}


function setupValidation() {
    const form = document.getElementById('deviceForm');
    if (!form) return;

    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => {
        ['input', 'change', 'blur', 'focus'].forEach(event => {
            field.addEventListener(event, function() {
                if (event === 'focus') clearFieldError(this);
                else validateField(this);
                updateFormButtons();
                if (event !== 'focus') updateProgressBar();
            });
        });
    });
    setupSubFormValidation();
    updateFormButtons();
}

function setupSubFormValidation() {
    const fieldGroups = [
        ['item_name', 'io_device_var', 'tag_name_var', 'address', 'equipment_var', 'data_type'],
        ['alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm'],
        ['tag_description', 'trend_types', 'tag_name', 'item_name_trend', 'trend_time']
    ];

    fieldGroups.flat().forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            ['input', 'change', 'blur', 'focus'].forEach(event => {
                field.addEventListener(event, function() {
                    if (event === 'focus') clearFieldError(this);
                    else validateField(this);
                    updateFormButtons();
                });
            });
        }
    });
}

function validateField(field) {
    const fieldName = field.name || field.id;
    const value = field.value.trim();
    const rules = validationRules[fieldName];

    if (!rules || (!isFieldVisible(field) && !isSubFormField(fieldName))) {
        delete validationErrors[fieldName];
        clearFieldError(field);
        return true;
    }

    let isValid = true;
    let errorMessage = '';


    if (rules.required && !value) {
        isValid = false;
        errorMessage = `${getFieldLabel(field)} is required`;
    }


    if (value) {
        if (rules.minLength && value.length < rules.minLength) {
            isValid = false;
            errorMessage = `${getFieldLabel(field)} must be at least ${rules.minLength} characters`;
        }
        if (rules.maxLength && value.length > rules.maxLength) {
            isValid = false;
            errorMessage = `${getFieldLabel(field)} must not exceed ${rules.maxLength} characters`;
        }
        if (rules.pattern && !rules.pattern.test(value)) {
            isValid = false;
            errorMessage = rules.message || `${getFieldLabel(field)} format is invalid`;
        }
        if (rules.min !== undefined || rules.max !== undefined) {
            const numValue = parseInt(value);
            if (isNaN(numValue)) {
                isValid = false;
                errorMessage = `${getFieldLabel(field)} must be a valid number`;
            } else {
                if (rules.min !== undefined && numValue < rules.min) {
                    isValid = false;
                    errorMessage = `${getFieldLabel(field)} must be at least ${rules.min}`;
                }
                if (rules.max !== undefined && numValue > rules.max) {
                    isValid = false;
                    errorMessage = `${getFieldLabel(field)} must not exceed ${rules.max}`;
                }
            }
        }
    }


    if (!isValid) {
        validationErrors[fieldName] = errorMessage;
        showFieldError(field, errorMessage);
    } else {
        delete validationErrors[fieldName];
        clearFieldError(field);
    }

    return isValid;
}

function isSubFormField(fieldName) {
    const subFormFields = [
        'item_name', 'io_device_var', 'tag_name_var', 'address', 'equipment_var', 'data_type',
        'alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm',
        'tag_description', 'trend_types', 'tag_name', 'item_name_trend', 'trend_time'
    ];
    return subFormFields.includes(fieldName);
}

function isFieldVisible(field) {
    if (field.offsetParent === null) return false;
    const fieldName = field.name || field.id;

    if (currentProtocol === 'modbus') {
        if (fieldName.startsWith('iec_')) return false;
        if (currentModbusVariant === 'tcp') {
            return !['gateway_address', 'slave_id', 'port_name_rtu', 'memory_rtu', 'serial_port', 'baud_rate'].includes(fieldName);
        } else {
            return !['device_ip', 'modbus_port', 'port_name', 'memory_tcp', 'unit_number'].includes(fieldName);
        }
    } else if (currentProtocol === 'iec') {
        return !['device_ip', 'modbus_port', 'port_name', 'unit_number', 'memory_tcp', 'gateway_address', 'slave_id', 'port_name_rtu', 'memory_rtu', 'serial_port'].includes(fieldName);
    }
    return true;
}

function getFieldLabel(field) {
    const labels = {
        device_name: 'Device Name', device_type: 'Device Type', tag_prefix: 'Tag Prefix',
        io_device: 'I/O Device', device_ip: 'Device IP', modbus_port: 'Modbus Port',
        iec_device_ip: 'IEC Device IP', item_name: 'Item Name', alarm_name: 'Alarm Name'
    };
    return labels[field.name || field.id] || (field.name || field.id).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function showFieldError(field, message) {
    field.classList.add('field-error');
    const existingError = field.parentNode.querySelector('.error-message');
    if (existingError) existingError.remove();

    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    errorDiv.style.cssText = 'color: #dc3545; font-size: 0.8rem; margin-top: 4px;';
    field.parentNode.insertBefore(errorDiv, field.nextSibling);
    field.style.cssText = 'border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;';
}

function clearFieldError(field) {
    field.classList.remove('field-error');
    const errorMessage = field.parentNode.querySelector('.error-message');
    if (errorMessage) errorMessage.remove();
    field.style.cssText = '';
}


function isFormComplete(type) {
    let requiredFields;
    switch (type) {
        case 'variable':
            requiredFields = ['item_name', 'io_device_var', 'tag_name_var', 'address', 'equipment_var', 'data_type'];
            break;
        case 'alarm':
            requiredFields = ['alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm'];
            break;
        case 'trend':
            requiredFields = ['tag_description', 'trend_types', 'tag_name', 'item_name_trend'];
            break;
        case 'main':
            requiredFields = getMainFormRequiredFields();
            break;
        default:
            return false;
    }

    const allFieldsFilled = requiredFields.every(fieldName => {
        const field = document.getElementById(fieldName);
        return field && field.value.trim() !== '';
    });

    const hasErrors = requiredFields.some(fieldName => validationErrors.hasOwnProperty(fieldName));
    return allFieldsFilled && !hasErrors;
}

function getMainFormRequiredFields() {
    const requiredFields = ['device_name', 'device_type', 'tag_prefix', 'io_device'];

    if (currentProtocol === 'modbus') {
        if (currentModbusVariant === 'tcp') {
            requiredFields.push('device_ip', 'modbus_port', 'port_name', 'memory_tcp');
        } else {
            requiredFields.push('gateway_address', 'slave_id', 'port_name_rtu', 'serial_port', 'memory_rtu');
            if (document.getElementById('advancedOptionsCheckbox')?.checked) {
                requiredFields.push('baud_rate');
            }
        }
    } else if (currentProtocol === 'iec') {
        requiredFields.push('iec_device_ip', 'iec_port', 'ied_name', 'access_point', 'logical_device');
    }

    return requiredFields;
}

function updateFormButtons() {
    const buttonConfigs = [
        { selector: 'button[onclick="saveDevice()"]', condition: () => isFormComplete('main'), title: 'Save device configuration' },
        { selector: 'button[onclick="generateCSV()"]', condition: () => devices.length > 0, title: 'Generate CSV files' },
        { selector: 'button[onclick="addVariable()"]', condition: () => isFormComplete('variable'), title: 'Add variable' },
        { selector: 'button[onclick="addAlarm()"]', condition: () => isFormComplete('alarm'), title: 'Add alarm' },
        { selector: 'button[onclick="addTrend()"]', condition: () => isFormComplete('trend'), title: 'Add trend' }
    ];

    buttonConfigs.forEach(({ selector, condition, title }) => {
        const button = document.querySelector(selector);
        if (button) {
            const isEnabled = condition();
            button.disabled = !isEnabled;
            button.style.cssText = isEnabled ? '' : 'background-color: #6c757d !important; cursor: not-allowed !important; opacity: 0.6 !important;';
            button.title = title;
        }
    });
}

function updateProgressBar() {
    const form = document.getElementById('deviceForm');
    if (!form) return;

    const requiredFields = form.querySelectorAll('input[required], select[required]');
    let filledFields = 0, visibleRequiredFields = 0;

    requiredFields.forEach(field => {
        if (isFieldVisible(field)) {
            visibleRequiredFields++;
            if (field.value.trim() !== '' && !validationErrors[field.name || field.id]) {
                filledFields++;
            }
        }
    });

    const progress = visibleRequiredFields > 0 ? (filledFields / visibleRequiredFields) * 100 : 0;
    const progressFill = document.querySelector('.progress-fill');
    const progressText = document.querySelector('.progress-text');

    if (progressFill) {
        progressFill.style.width = progress + '%';
        const errorCount = Object.keys(validationErrors).length;
        progressFill.style.backgroundColor = errorCount > 0 ? '#dc3545' : progress === 100 ? '#28a745' : '#007bff';
    }

    if (progressText) {
        const errorCount = Object.keys(validationErrors).length;
        if (errorCount > 0) {
            progressText.textContent = `${errorCount} error${errorCount > 1 ? 's' : ''} to fix`;
            progressText.style.color = '#dc3545';
        } else if (progress === 100) {
            progressText.textContent = 'Form complete - ready to save';
            progressText.style.color = '#28a745';
        } else {
            progressText.textContent = `${Math.round(progress)}% complete`;
            progressText.style.color = '#007bff';
        }
    }
}


function showTab(tabName, event) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    if (event?.target) event.target.classList.add('active');
    const targetContent = document.getElementById(tabName);
    if (targetContent) targetContent.classList.add('active');
}

function selectProtocol(protocol) {
    currentProtocol = protocol;

    document.querySelectorAll('.protocol-btn').forEach(btn => {
        btn.classList.toggle('active',
            (protocol === 'modbus' && btn.textContent.includes('Modbus')) ||
            (protocol === 'iec' && btn.textContent.includes('IEC'))
        );
    });

    const modbusConfig = document.getElementById('modbus-config');
    const iecConfig = document.getElementById('iec-config');
    const cidElements = ['cidInputLabel', 'cidFile'];

    if (protocol === 'modbus') {
        modbusConfig?.classList.remove('hidden');
        iecConfig?.classList.add('hidden');
        cidElements.forEach(id => document.getElementById(id)?.classList.add('hidden'));
        updateProtocolSelect(currentModbusVariant === 'tcp' ? 'Modbus TCP' : 'Modbus RTU');
    } else {
        modbusConfig?.classList.add('hidden');
        iecConfig?.classList.remove('hidden');
        cidElements.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
        updateProtocolSelect('IEC61850');
    }

    clearProtocolErrors();
    updateFormButtons();
    updateProgressBar();
}

function updateProtocolSelect(value) {
    const protocolSelect = document.getElementById('protocol');
    if (protocolSelect) {
        protocolSelect.innerHTML = `<option value="${value}">${value.replace('TCP', 'TCP/IP')}</option>`;
    }
}

function selectModbusVariant(variant) {
    currentModbusVariant = variant;

    document.querySelectorAll('.modbus-variant-btn').forEach(btn => {
        btn.classList.toggle('active',
            (variant === 'tcp' && btn.textContent.trim() === 'TCP/IP') ||
            (variant === 'rtu' && btn.textContent.trim() === 'RTU')
        );
    });

    const tcpConfig = document.getElementById('modbus-tcp-config');
    const rtuConfig = document.getElementById('modbus-rtu-config');

    if (variant === 'tcp') {
        tcpConfig?.classList.remove('hidden');
        rtuConfig?.classList.add('hidden');
        updateProtocolSelect('Modbus TCP');
    } else {
        tcpConfig?.classList.add('hidden');
        rtuConfig?.classList.remove('hidden');
        updateProtocolSelect('Modbus RTU');
    }

    clearProtocolErrors();
    updateFormButtons();
    updateProgressBar();
}

function clearProtocolErrors() {
    const protocolFields = [
        'device_ip', 'modbus_port', 'port_name', 'unit_number',
        'gateway_address', 'slave_id', 'port_name_rtu', 'serial_port',
        'iec_device_ip', 'iec_port', 'ied_name', 'access_point', 'logical_device'
    ];

    protocolFields.forEach(fieldName => {
        delete validationErrors[fieldName];
        const field = document.getElementById(fieldName);
        if (field) clearFieldError(field);
    });
}

function toggleAdvancedOptions() {
    const checkbox = document.getElementById('advancedOptionsCheckbox');
    const content = document.getElementById('advancedOptionsContent');
    const advancedFields = ['baud_rate', 'data_bits', 'parity', 'stop_bits'];

    const isEnabled = checkbox?.checked;

    if (content) content.classList.toggle('enabled', isEnabled);

    advancedFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.disabled = !isEnabled;
            if (!isEnabled) {
                delete validationErrors[fieldId];
                clearFieldError(field);
            }
        }
    });

    updateFormButtons();
}


function addVariable() {
    if (!isFormComplete('variable')) {
        showAlert('Please complete all variable fields before adding', 'error');
        return;
    }

    const fields = ['item_name', 'io_device_var', 'data_type', 'tag_name_var', 'address', 'equipment_var'];
    const values = fields.map(id => document.getElementById(id).value.trim());

    if (variables.some(v => v.item_name?.toLowerCase() === values[0].toLowerCase())) {
        showAlert('Variable name already exists', 'error');
        return;
    }

    const variable = {
        id: Date.now().toString(),
        item_name: values[0],
        io_device: values[1],
        data_type: values[2],
        tag_name: values[3],
        address: values[4],
        equipment: values[5]
    };

    variables.push(variable);
    updateVariableTable();
    clearForm('variable');
    showAlert('Variable added successfully!', 'success');
}

function updateVariableTable() {
    const tbody = document.getElementById('variableTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';
    variables.forEach(variable => {
        const row = createEditableRow(variable, 'variable', [
            'item_name', 'io_device', 'tag_name', 'address', 'equipment', 'data_type'
        ]);
        tbody.appendChild(row);
    });
}

function createEditableRow(item, type, fields) {
    const row = document.createElement('tr');
    row.className = 'editable-row';
    row.setAttribute('data-id', item.id);

    const fieldMap = {
        variable: { data_type: ['float', 'int', 'bool', 'string', 'REAL', 'INT'] },
        alarm: {
            alarm_type: ['analog', 'digital', 'advanced'],
            category: ['low', 'medium', 'high', 'event']
        },
        trend: { trend_types: ['event', 'periodic', 'periodic-event'] }
    };

    fields.forEach(field => {
        const cell = document.createElement('td');
        const value = item[field] || item[field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())] || '';

        if (fieldMap[type] && fieldMap[type][field]) {
            const select = document.createElement('select');
            select.className = 'editable-select';
            select.onchange = () => updateItemField(item.id, field, select.value, type);
            select.onblur = () => saveItemChanges(item.id, type);

            fieldMap[type][field].forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option.charAt(0).toUpperCase() + option.slice(1);
                opt.selected = value === option;
                select.appendChild(opt);
            });
            cell.appendChild(select);
        } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editable-cell';
            input.value = value;
            input.onchange = () => updateItemField(item.id, field, input.value, type);
            input.onblur = () => saveItemChanges(item.id, type);
            cell.appendChild(input);
        }
        row.appendChild(cell);
    });


    const actionCell = document.createElement('td');
    actionCell.className = 'action-buttons';
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn btn-danger';
    removeBtn.textContent = 'Remove';
    removeBtn.style.cssText = 'background: #dc3545; padding: 6px 12px; font-size: 0.8rem;';
    removeBtn.onclick = () => removeItem(item.id, type);
    actionCell.appendChild(removeBtn);
    row.appendChild(actionCell);

    return row;
}

function updateItemField(id, field, value, type) {
    const collections = { variable: variables, alarm: alarms, trend: trends };
    const item = collections[type].find(i => i.id === id);
    if (item) item[field] = value;
}

function saveItemChanges(id, type) {
    showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} updated successfully!`, 'success');
}

function removeItem(id, type) {
    if (confirm(`Are you sure you want to remove this ${type}?`)) {
        const collections = { variable: variables, alarm: alarms, trend: trends };
        const updateFunctions = {
            variable: updateVariableTable,
            alarm: updateAlarmTable,
            trend: updateTrendTable
        };

        collections[type] = collections[type].filter(i => i.id !== id);
        updateFunctions[type]();
        showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} removed successfully!`, 'success');
    }
}

function clearForm(type) {
    const fieldMaps = {
        variable: ['item_name', 'io_device_var', 'data_type', 'tag_name_var', 'address', 'equipment_var'],
        alarm: ['alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm'],
        trend: ['tag_description', 'trend_types', 'tag_name', 'item_name_trend', 'trend_time']
    };

    fieldMaps[type].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = field.tagName === 'SELECT' ? field.options[0].value : '';
            clearFieldError(field);
            delete validationErrors[fieldId];
        }
    });
    updateFormButtons();
}


function addAlarm() {
    if (!isFormComplete('alarm')) {
        showAlert('Please complete all alarm fields before adding', 'error');
        return;
    }

    const fields = ['alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm'];
    const values = fields.map(id => document.getElementById(id).value.trim());

    if (alarms.some(a => a.alarm_name?.toLowerCase() === values[0].toLowerCase())) {
        showAlert('Alarm name already exists', 'error');
        return;
    }

    const alarm = {
        id: Date.now().toString(),
        alarm_name: values[0],
        alarm_type: values[1],
        category: values[2],
        alarm_tag: values[3],
        equipment: values[4],
        item_name: values[5]
    };

    alarms.push(alarm);
    updateAlarmTable();
    clearForm('alarm');
    showAlert('Alarm added successfully!', 'success');
}

function updateAlarmTable() {
    const tbody = document.getElementById('alarmTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';
    alarms.forEach(alarm => {
        const row = createEditableRow(alarm, 'alarm', [
            'alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name'
        ]);
        tbody.appendChild(row);
    });
}


function addTrend() {
    if (!isFormComplete('trend')) {
        showAlert('Please complete all trend fields before adding', 'error');
        return;
    }

    const fields = ['tag_description', 'trend_types', 'tag_name', 'item_name_trend'];
    const values = fields.map(id => document.getElementById(id).value.trim());
    const timeValue = document.getElementById('trend_time')?.value || '00:00';

    if (trends.some(t => t.tag_description?.toLowerCase() === values[0].toLowerCase())) {
        showAlert('Tag description already exists', 'error');
        return;
    }

    const trend = {
        id: Date.now().toString(),
        tag_description: values[0],
        trend_types: values[1],
        tag_name: values[2],
        item_name: values[3],
        time: timeValue
    };

    trends.push(trend);
    updateTrendTable();
    clearForm('trend');
    showAlert('Trend added successfully!', 'success');
}

function updateTrendTable() {
    const tbody = document.getElementById('trendTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';
    trends.forEach(trend => {
        const row = createEditableRow(trend, 'trend', [
            'tag_description', 'trend_types', 'tag_name', 'item_name', 'time'
        ]);
        tbody.appendChild(row);
    });
}


function saveDevice() {
    if (!performCompleteValidation()) {
        showAlert('Please fix all validation errors before saving', 'error');
        return;
    }

    const form = document.getElementById('deviceForm');
    const formData = new FormData(form);
    const deviceName = formData.get('device_name');


    const existingDevice = devices.find(d =>
        d.device_name.toLowerCase() === deviceName.toLowerCase() &&
        (!currentDevice || d.id !== currentDevice.id)
    );

    if (existingDevice) {
        showFieldError(document.getElementById('device_name'), 'Device name already exists');
        showAlert('Device name already exists. Please choose a different name.', 'error');
        return;
    }

    const device = {
        id: currentDevice ? currentDevice.id : Date.now().toString(),
        protocol: currentProtocol,
        modbusVariant: currentModbusVariant,
        device_name: deviceName,
        device_type: formData.get('device_type'),
        tag_prefix: formData.get('tag_prefix'),
        io_device: formData.get('io_device'),
        variables: [...variables],
        alarms: [...alarms],
        trends: [...trends]
    };


    if (currentProtocol === 'modbus') {
        if (currentModbusVariant === 'tcp') {
            Object.assign(device, {
                device_ip: formData.get('device_ip'),
                modbus_port: formData.get('modbus_port'),
                port_name: formData.get('port_name'),
                unit_number: formData.get('unit_number'),
                memory: formData.get('memory')
            });
        } else {
            Object.assign(device, {
                gateway_address: formData.get('gateway_address'),
                slave_id: formData.get('slave_id'),
                port_name_rtu: formData.get('port_name_rtu'),
                memory_rtu: formData.get('memory_rtu'),
                serial_port: formData.get('serial_port')
            });

            if (document.getElementById('advancedOptionsCheckbox').checked) {
                Object.assign(device, {
                    baud_rate: formData.get('baud_rate'),
                    data_bits: formData.get('data_bits'),
                    parity: formData.get('parity'),
                    stop_bits: formData.get('stop_bits')
                });
            }
        }
        device.protocol_name = formData.get('protocol');
    } else if (currentProtocol === 'iec') {
        Object.assign(device, {
            iec_device_ip: formData.get('iec_device_ip'),
            iec_port: formData.get('iec_port'),
            ied_name: formData.get('ied_name'),
            access_point: formData.get('access_point'),
            logical_device: formData.get('logical_device'),
            report_control: formData.get('report_control'),
            protocol_name: 'IEC61850'
        });
    }


    if (currentDevice) {
        const index = devices.findIndex(d => d.id === currentDevice.id);
        if (index !== -1) devices[index] = device;
    } else {
        devices.push(device);
    }

    updateDeviceList();
    updateDeviceCounter();
    showAlert('Device saved successfully!', 'success');
    currentDevice = null;
}

function performCompleteValidation() {
    const form = document.getElementById('deviceForm');
    if (!form) return false;

    let isValid = true;
    validationErrors = {};

    form.querySelectorAll('input, select').forEach(field => {
        if (isFieldVisible(field) && !validateField(field)) {
            isValid = false;
        }
    });

    updateFormButtons();
    updateProgressBar();
    return isValid;
}

function resetForm() {
    const form = document.getElementById('deviceForm');
    if (form) form.reset();

    validationErrors = {};
    form.querySelectorAll('input, select').forEach(field => clearFieldError(field));

    variables = [];
    alarms = [];
    trends = [];
    currentDevice = null;

    updateVariableTable();
    updateAlarmTable();
    updateTrendTable();

    selectProtocol('modbus');
    selectModbusVariant('tcp');

    const advancedCheckbox = document.getElementById('advancedOptionsCheckbox');
    if (advancedCheckbox) {
        advancedCheckbox.checked = false;
        toggleAdvancedOptions();
    }

    updateFormButtons();
    updateProgressBar();
    showAlert('Form reset successfully!', 'success');
}

function updateDeviceList() {
    const deviceList = document.getElementById('deviceList');
    if (!deviceList) return;

    if (devices.length === 0) {
        deviceList.innerHTML = '<div class="placeholder-content"><p>No devices configured yet.</p></div>';
        return;
    }

    deviceList.innerHTML = devices.map(device => `
        <div class="device-item" onclick="loadDevice('${device.id}')" style="
            background: rgba(255,255,255,0.1); margin: 10px 0; padding: 12px; border-radius: 6px;
            cursor: pointer; transition: all 0.3s ease;"
            onmouseover="this.style.background='rgba(255,255,255,0.2)'"
            onmouseout="this.style.background='rgba(255,255,255,0.1)'">
            <div style="font-weight: bold; margin-bottom: 4px;">${device.device_name}</div>
            <div style="font-size: 0.9em; opacity: 0.8;">${device.device_type} - ${device.protocol.toUpperCase()}</div>
            <button onclick="event.stopPropagation(); removeDevice('${device.id}')" style="
                background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px;
                font-size: 0.8em; margin-top: 8px; cursor: pointer;">Remove</button>
        </div>
    `).join('');
}

function loadDevice(deviceId) {
    const device = devices.find(d => d.id === deviceId);
    if (!device) return;

    currentDevice = device;
    validationErrors = {};
    document.querySelectorAll('input, select').forEach(field => clearFieldError(field));


    const basicFields = ['device_name', 'device_type', 'tag_prefix', 'io_device'];
    basicFields.forEach(field => {
        const el = document.getElementById(field);
        if (el) el.value = device[field] || '';
    });

    selectProtocol(device.protocol);


    if (device.protocol === 'modbus') {
        selectModbusVariant(device.modbusVariant || 'tcp');

        const fieldMaps = {
            tcp: ['device_ip', 'modbus_port', 'port_name', 'unit_number'],
            rtu: ['gateway_address', 'slave_id', 'port_name_rtu', 'serial_port']
        };

        fieldMaps[device.modbusVariant || 'tcp'].forEach(field => {
            const el = document.getElementById(field);
            if (el) el.value = device[field] || '';
        });

        if (device.baud_rate) {
            document.getElementById('advancedOptionsCheckbox').checked = true;
            toggleAdvancedOptions();
            ['baud_rate', 'data_bits', 'parity', 'stop_bits'].forEach(field => {
                const el = document.getElementById(field);
                if (el) el.value = device[field] || '';
            });
        }
    } else if (device.protocol === 'iec') {
        const iecFields = ['iec_device_ip', 'iec_port', 'ied_name', 'access_point', 'logical_device', 'report_control'];
        iecFields.forEach(field => {
            const el = document.getElementById(field);
            if (el) el.value = device[field] || '';
        });
    }

    variables = device.variables || [];
    alarms = device.alarms || [];
    trends = device.trends || [];

    updateVariableTable();
    updateAlarmTable();
    updateTrendTable();
    updateFormButtons();
    updateProgressBar();
    showAlert('Device loaded successfully!', 'success');
}

function removeDevice(deviceId) {
    if (confirm('Are you sure you want to remove this device?')) {
        devices = devices.filter(d => d.id !== deviceId);
        updateDeviceList();
        updateDeviceCounter();
        updateFormButtons();
        showAlert('Device removed successfully!', 'success');
    }
}

function updateDeviceCounter() {
    const counter = document.getElementById('deviceCounter');
    if (counter) counter.textContent = devices.length;
}


function generateCSV() {
    if (devices.length === 0) {
        showAlert('No devices to export. Please save at least one device first.', 'error');
        return;
    }

    showLoading(true);
    setTimeout(() => {
        try {
            generateEquipmentCSV();
            generateUnitsCSV();
            generateVariablesCSV();
            generateAlarmsCSV();
            generateTrendsCSV();
            showAlert('All CSV files generated successfully!', 'success');
        } catch (error) {
            showAlert('Error generating CSV files: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }, 1000);
}

function generateEquipmentCSV() {
    const headers = ['ITEM_NAME', 'EQUIP_TYPE', 'COMMENT', 'CUSTOM01', 'CUSTOM02'];
    const rows = [headers.join(',')];

    devices.forEach(device => {
        const row = [
            device.device_name,
            device.device_type,
            `${device.device_type} - ${device.device_name}`,
            device.tag_prefix,
            device.io_device
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'EQUIP.csv');
}

function generateUnitsCSV() {
    const headers = ['UNIT_NAME', 'UNIT_TYPE', 'PORT_NAME', 'IP_ADDRESS', 'PROTOCOL', 'MEMORY', 'UNIT_NUMBER'];
    const rows = [headers.join(',')];

    devices.forEach(device => {
        let row;
        if (device.protocol === 'modbus') {
            row = [
                device.device_name,
                'PLC',
                device.modbusVariant === 'tcp' ? (device.port_name || '') : (device.port_name_rtu || ''),
                device.modbusVariant === 'tcp' ? (device.device_ip || '') : (device.gateway_address || ''),
                device.protocol_name || 'Modbus TCP',
                device.modbusVariant === 'tcp' ? (device.memory || 'TRUE') : (device.memory_rtu || 'TRUE'),
                device.modbusVariant === 'tcp' ? (device.unit_number || '1') : (device.slave_id || '1')
            ];
        } else {
            row = [
                device.device_name,
                'IED',
                device.ied_name || '',
                device.iec_device_ip || '',
                'IEC61850',
                'TRUE',
                device.iec_port || '102'
            ];
        }
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'UNITS.csv');
}

function generateVariablesCSV() {
    if (variables.length === 0) {
        showAlert('No variables configured', 'error');
        return;
    }

    const headers = ['Equipment', 'Item Name', 'Tag Name', 'I/O Device', 'Data Type', 'Address'];
    const rows = [headers.join(',')];

    variables.forEach(variable => {
        const row = [
            variable.equipment || '',
            variable.item_name || '',
            variable.tag_name || '',
            variable.io_device || '',
            variable.data_type || '',
            variable.address || ''
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'VARIABLES.csv');
}

function generateAlarmsCSV() {
    if (alarms.length === 0) {
        showAlert('No alarms configured', 'error');
        return;
    }

    const headers = ['EQUIPMENT', 'ITEM_NAME', 'ALARM_TAG', 'ALARM_NAME', 'CATEGORY', 'ALARM_TYPE'];
    const rows = [headers.join(',')];

    alarms.forEach(alarm => {
        const row = [
            alarm.equipment || '',
            alarm.item_name || '',
            alarm.alarm_tag || '',
            alarm.alarm_name || '',
            alarm.category || '',
            alarm.alarm_type || ''
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'ALARMS.csv');
}

function generateTrendsCSV() {
    if (trends.length === 0) {
        showAlert('No trends configured', 'error');
        return;
    }

    const headers = ['TAG_DESCRIPTION', 'TREND_TYPES', 'TAG_NAME', 'ITEM_NAME', 'TIME'];
    const rows = [headers.join(',')];

    trends.forEach(trend => {
        const row = [
            trend.tag_description || '',
            trend.trend_types || '',
            trend.tag_name || '',
            trend.item_name || '',
            trend.time || '00:00'
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'TRENDS.csv');
}


function loadCSV(event) {
    const file = event.target.files[0];
    if (!file || !file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Please select a valid CSV file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                showAlert('CSV file appears to be empty', 'error');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());

            if (headers.includes('ITEM_NAME') && headers.includes('EQUIP_TYPE')) {
                loadEquipmentFromCSV(lines);
            } else if (headers.includes('UNIT_NAME') && headers.includes('PROTOCOL')) {
                loadUnitsFromCSV(lines);
            } else {
                showAlert('CSV format not recognized', 'error');
                return;
            }

            showAlert('CSV loaded successfully!', 'success');
        } catch (error) {
            showAlert('Error loading CSV: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function loadVariablesCSV(event) {
    loadItemsFromCSV(event, 'variables', (values, headers) => ({
        id: Date.now().toString() + Math.random(),
        equipment: getValueByHeader(values, headers, ['Equipment']),
        item_name: getValueByHeader(values, headers, ['Item Name', 'ITEM_NAME']),
        tag_name: getValueByHeader(values, headers, ['Tag Name', 'TAG_NAME']),
        io_device: getValueByHeader(values, headers, ['I/O Device', 'IO_DEVICE']),
        data_type: getValueByHeader(values, headers, ['Data Type', 'DATA_TYPE']) || 'float',
        address: getValueByHeader(values, headers, ['Address', 'ADDRESS'])
    }), () => {
        updateVariableTable();
        variables = [...variables];
    });
}

function loadAlarmsCSV(event) {
    loadItemsFromCSV(event, 'alarms', (values, headers) => ({
        id: Date.now().toString() + Math.random(),
        equipment: getValueByHeader(values, headers, ['Equipment']),
        item_name: getValueByHeader(values, headers, ['Item Name']),
        alarm_tag: getValueByHeader(values, headers, ['Alarm Tag']),
        alarm_name: getValueByHeader(values, headers, ['Alarm Name']),
        category: getValueByHeader(values, headers, ['Category']),
        alarm_type: 'analog'
    }), () => {
        updateAlarmTable();
        alarms = [...alarms];
    });
}

function loadTrendsCSV(event) {
    loadItemsFromCSV(event, 'trends', (values, headers) => ({
        id: Date.now().toString() + Math.random(),
        equipment: getValueByHeader(values, headers, ['Equipment']),
        item_name: getValueByHeader(values, headers, ['Item Name']),
        tag_name: getValueByHeader(values, headers, ['Tag Name']),
        tag_description: getValueByHeader(values, headers, ['Comment', 'Tag Description']),
        trend_types: 'periodic',
        time: '00:00'
    }), () => {
        updateTrendTable();
        trends = [...trends];
    });
}

function loadItemsFromCSV(event, type, createItem, callback) {
    const file = event.target.files[0];
    if (!file || !file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Please select a valid CSV file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                showAlert(`${type} CSV file appears to be empty`, 'error');
                return;
            }

            const headers = parseCSVLine(lines[0]);
            const collections = { variables, alarms, trends };
            collections[type] = [];

            let successCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const item = createItem(values, headers);

                if (item && (item.item_name || item.tag_name || item.equipment)) {
                    collections[type].push(item);
                    successCount++;
                }
            }

            callback();
            showAlert(`Successfully imported ${successCount} ${type}!`, 'success');
        } catch (error) {
            showAlert(`Error loading ${type} CSV: ` + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }

    result.push(current.trim());
    return result.map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"'));
}

function getValueByHeader(values, headers, possibleNames) {
    for (let name of possibleNames) {
        const index = headers.findIndex(h => h.toUpperCase() === name.toUpperCase());
        if (index !== -1 && values[index]) return values[index];
    }
    return '';
}


function loadCID(event) {
    const file = event.target.files[0];
    if (!file || !file.name.toLowerCase().endsWith('.cid')) {
        showAlert('Please select a valid CID file', 'error');
        return;
    }

    showLoading(true);
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const cidContent = e.target.result;
            if (!cidContent.includes('<?xml') || !cidContent.includes('<SCL')) {
                showAlert('Invalid CID file format', 'error');
                showLoading(false);
                return;
            }

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(cidContent, 'text/xml');

            if (xmlDoc.querySelector('parsererror')) {
                showAlert('Error parsing CID file: Invalid XML', 'error');
                showLoading(false);
                return;
            }

            parseCIDData(xmlDoc);
        } catch (error) {
            showAlert('Error loading CID file: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    };
    reader.readAsText(file);
}

function parseCIDData(xmlDoc) {
    try {
        validationErrors = {};
        selectProtocol('iec');


        const communication = xmlDoc.querySelector('Communication');
        if (communication) {
            const connectedAP = communication.querySelector('ConnectedAP');
            if (connectedAP) {
                const iedName = connectedAP.getAttribute('iedName');
                const apName = connectedAP.getAttribute('apName');

                if (iedName) document.getElementById('ied_name').value = iedName;
                if (apName) document.getElementById('access_point').value = apName;

                const address = connectedAP.querySelector('Address');
                if (address) {
                    const ipElement = address.querySelector('P[type="IP"]');
                    if (ipElement) {
                        document.getElementById('iec_device_ip').value = ipElement.textContent;
                    }
                }
            }
        }


        const ieds = xmlDoc.querySelectorAll('IED');
        if (ieds.length > 0) {
            const firstIED = ieds[0];
            const iedName = firstIED.getAttribute('name');
            const iedType = firstIED.getAttribute('type') || 'IED';

            document.getElementById('device_name').value = iedName || 'IED_Device';
            document.getElementById('device_type').value = iedType;
            document.getElementById('tag_prefix').value = (iedName || 'IED').substring(0, 10).toUpperCase();

            const accessPoint = firstIED.querySelector('AccessPoint');
            if (accessPoint) {
                document.getElementById('access_point').value = accessPoint.getAttribute('name');

                const lDevice = accessPoint.querySelector('LDevice');
                if (lDevice) {
                    document.getElementById('logical_device').value = lDevice.getAttribute('inst') || 'LD0';
                }
            }
        }

        if (!document.getElementById('iec_port').value) {
            document.getElementById('iec_port').value = '102';
        }

        updateFormButtons();
        updateProgressBar();
        showAlert('CID file parsed successfully!', 'success');
    } catch (error) {
        showAlert('Error parsing CID data: ' + error.message, 'error');
    }
}


function loadEquipmentFromCSV(lines) {
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values[0]) {
            const device = {
                id: Date.now().toString() + i,
                device_name: values[0] || '',
                device_type: values[1] || '',
                tag_prefix: values[3] || '',
                io_device: values[4] || '',
                protocol: 'modbus',
                modbusVariant: 'tcp',
                variables: [], alarms: [], trends: []
            };
            devices.push(device);
        }
    }
    updateDeviceList();
    updateDeviceCounter();
}

function loadUnitsFromCSV(lines) {

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values[0]) {
            const device = {
                id: Date.now().toString() + i,
                device_name: values[0] || '',
                device_type: values[1] === 'IED' ? 'IED' : 'PLC',
                port_name: values[2] || '',
                device_ip: values[3] || '',
                protocol_name: values[4] || '',
                protocol: values[4]?.includes('IEC') ? 'iec' : 'modbus',
                variables: [], alarms: [], trends: []
            };
            devices.push(device);
        }
    }
    updateDeviceList();
    updateDeviceCounter();
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');

    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
    alert.textContent = message;

    const container = document.querySelector('.container');
    if (container) {
        container.insertBefore(alert, container.firstChild);
        setTimeout(() => {
            if (alert.parentNode) alert.parentNode.removeChild(alert);
        }, 5000);
    }
}

function showLoading(show) {
    const loading = document.getElementById('loading');
    const form = document.getElementById('deviceForm');

    if (loading) {
        loading.classList.toggle('show', show);
        if (form) form.style.display = show ? 'none' : 'block';
    }
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Device Configuration Generator - Schneider Electric</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .main-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: #3dcd68;
      color: white;
      padding: 20px;
    }

    .container {
      flex: 1;
      padding: 20px;
      background: white;
      margin: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header {
      margin-bottom: 30px;
    }

    .header h1 {
      color: #3dcd68;
      margin-bottom: 20px;
    }

    .config-section {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .config-section h3 {
      color: #3dcd68;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 20px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #3dcd68;
    }

    .config-cards {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
    }

    .config-card {
      flex: 1;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .config-card:hover {
      border-color: #3dcd68;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    }

    .config-card h4 {
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .config-card p {
      color: #666;
      font-size: 0.9rem;
      margin: 0;
    }

    .protocol-selection {
      background: #e8f5e8;
      border: 3px solid #3dcd68;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      text-align: center;
    }

    .protocol-selection h2 {
      color: #2d7a3d;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 24px 0;
    }

    .protocol-buttons {
      display: flex;
      gap: 24px;
      justify-content: center;
      margin-top: 24px;
    }

    .protocol-btn {
      flex: 1;
      max-width: 200px;
      background: white;
      border: 3px solid #3dcd68;
      border-radius: 12px;
      padding: 24px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 600;
      color: #3dcd68;
    }

    .protocol-btn:hover {
      background: #3dcd68;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.25);
    }

    .protocol-btn.active {
      background: #3dcd68;
      color: white;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      position: relative;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-icon {
      width: 18px;
      height: 18px;
      background: #3dcd68;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: help;
      position: relative;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      background: #2db555;
    }

    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      max-width: 300px;
      min-width: 180px;
      white-space: normal;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      pointer-events: none;
      text-align: left;
      border: 1px solid #555;
      top: 25px;
      left: 50%;
      transform: translateX(-50%);
    }

    .tooltip::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #333;
    }

    .info-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    .hidden {
      display: none !important;
    }

    .file-input-label {
      display: inline-block;
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-right: 10px;
      font-weight: 600;
    }

    .file-input-label:hover {
      background: #0056b3;
    }

    .file-input {
      display: none;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-secondary {
      background: #007bff;
      color: white;
    }

    .btn-secondary:hover {
      background: #007bff;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .button-group {
      display: flex;
      gap: 16px;
      margin-top: 24px;
      align-items: center;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin: 24px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3dcd68, #28a745);
      width: 0%;
      transition: width 0.3s ease;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3dcd68;
      box-shadow: 0 0 0 3px rgba(61, 205, 104, 0.1);
    }

    input:disabled, select:disabled, textarea:disabled {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3dcd68;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active, .tab:hover {
      color: #3dcd68;
      border-bottom-color: #3dcd68;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .alert {
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .file-upload-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
    }

    .file-upload-section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 1.1rem;
    }

    .file-upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .data-table th {
      background: #f8f9fa;
      padding: 12px;
      border: 1px solid #dee2e6;
      text-align: left;
      font-weight: 600;
      color: #333;
    }

    .data-table td {
      padding: 12px;
      border: 1px solid #dee2e6;
    }

    .editable-cell {
      background: transparent;
      border: none;
      width: 100%;
      padding: 4px;
      font-size: 14px;
    }

    .editable-cell:focus {
      background: #fff3cd;
      border: 1px solid #ffc107;
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }

    .modbus-variant-selection {
      background: #e8f4fd;
      border: 2px solid #007bff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .modbus-variant-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 16px;
    }

    .modbus-variant-btn {
      flex: 1;
      max-width: 150px;
      background: white;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 600;
      color: #007bff;
      text-align: center;
    }

    .modbus-variant-btn:hover {
      background: #007bff;
      color: white;
    }

    .modbus-variant-btn.active {
      background: #007bff;
      color: white;
    }

    .advanced-options-toggle {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .advanced-options-toggle:hover {
      background: #e9ecef;
    }

    .checkbox-container {
      position: relative;
      display: inline-block;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
    }

    .advanced-options-toggle label {
      margin: 0;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #495057;
    }

    .advanced-options-content {
      transition: all 0.3s ease;
      opacity: 0.5;
      pointer-events: none;
    }

    .advanced-options-content.enabled {
      opacity: 1;
      pointer-events: all;
    }

    @media (max-width: 768px) {
      .config-cards {
        flex-direction: column;
      }

      .protocol-buttons {
        flex-direction: column;
      }

      .form-grid-2, .form-grid-3 {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .file-upload-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar">
      <h3>Saved Devices <span class="device-counter" id="deviceCounter">0</span></h3>
      <div class="device-list" id="deviceList">
        <div class="placeholder-content">
          <p>No devices configured yet.</p>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>Device Configuration Generator</h1>

          <div class="file-upload-section">
            <h3>File Upload</h3>
            <div class="file-upload-grid">
              <div>
                <input type="file" id="csvFile" class="file-input" accept=".csv" />
                <label for="csvFile" class="file-input-label">Load CSV</label>
              </div>
              <div>
                <input type="file" id="variablesCsvFile" class="file-input" accept=".csv" />
                <label for="variablesCsvFile" class="file-input-label">Load Variables CSV</label>
              </div>
              <div>
                <input type="file" id="alarmsCsvFile" class="file-input" accept=".csv" />
                <label for="alarmsCsvFile" class="file-input-label">Load Alarms CSV</label>
              </div>
              <div>
                <input type="file" id="trendsCsvFile" class="file-input" accept=".csv" />
                <label for="trendsCsvFile" class="file-input-label">Load Trends CSV</label>
              </div>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" onclick="showTab('device-info', event)">Device Info</button>
            <button class="tab" onclick="showTab('variables', event)">Variables</button>
            <button class="tab" onclick="showTab('alarms', event)">Alarms</button>
            <button class="tab" onclick="showTab('trends', event)">Trends</button>
          </div>
        </div>
      </div>

      <div class="tab-content active" id="device-info">
        <div class="protocol-selection">
          <h2>Select Communication Protocol</h2>
          <p>Choose the communication protocol that will be used for this device configuration</p>
          <div class="protocol-buttons">
            <button class="protocol-btn active" onclick="selectProtocol('modbus')">
              <div>Modbus</div>
            </button>
            <button class="protocol-btn" onclick="selectProtocol('iec')">
              <div>IEC 61850</div>
            </button>
          </div>
        </div>

        <form id="deviceForm">
          <div class="config-cards">
            <div class="config-card" onclick="generateEquipmentConfig()">
              <h4>Equipment Config</h4>
              <p>Generate EQUIP.csv with device specifications</p>
            </div>
            <div class="config-card" onclick="generateUnitsConfig()">
              <h4>Units Config</h4>
              <p>Generate UNITS.csv with network settings</p>
            </div>
          </div>

          <div class="config-section">
            <h3>Device Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="device_name">
                  Device Name
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Enter a unique device name. Use only letters, numbers, and underscores. Example: PV_Panel_01, Wind_Turbine_07
                    </div>
                  </div>
                </label>
                <input type="text" name="device_name" id="device_name" required placeholder="e.g. PV_Panel_01" />
              </div>

              <div class="form-group">
                <label for="device_type">
                  Device Type
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Select the device type from the list. This determines which variables and configurations will be available for this device.
                    </div>
                  </div>
                </label>
                <select name="device_type" id="device_type" required>
                  <option value="">Select device type</option>
                  <option value="PV">PV Panel</option>
                  <option value="WindTurbine">Wind Turbine</option>
                  <option value="FuelTurbine">Fuel Turbine</option>
                  <option value="FuelCell">Fuel Cell</option>
                  <option value="BESS">BESS</option>
                </select>
              </div>

              <div class="form-group">
                <label for="tag_prefix">
                  Tag Prefix
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Prefix used for all tags of this device. Should be short and unique. Example: FugaPV1, BESS01
                    </div>
                  </div>
                </label>
                <input type="text" name="tag_prefix" id="tag_prefix" required placeholder="e.g. FugaPV1" />
              </div>

              <div class="form-group">
                <label for="io_device">
                  I/O Device
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Name of the physical I/O device or inverter to which the device is connected. Example: Inverter_PV1
                    </div>
                  </div>
                </label>
                <input type="text" name="io_device" id="io_device" required placeholder="e.g. Inverter_PV1" />
              </div>
            </div>
          </div>

          <div class="config-section" id="modbus-config">
            <h3>Modbus Network Configuration</h3>

            <div class="modbus-variant-selection">
              <h4 style="margin: 0 0 10px 0; color: #007bff;">Select Modbus Variant</h4>
              <p style="margin: 0 0 16px 0; color: #666; font-size: 0.9rem;">Choose between TCP/IP or RTU communication</p>
              <div class="modbus-variant-buttons">
                <button type="button" class="modbus-variant-btn active" onclick="selectModbusVariant('tcp')">
                  TCP/IP
                </button>
                <button type="button" class="modbus-variant-btn" onclick="selectModbusVariant('rtu')">
                  RTU
                </button>
              </div>
            </div>

            <div id="modbus-tcp-config">
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="device_ip">
                    Device IP Address
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        IP address of the device on the network. Must be in IPv4 format (e.g. 192.168.1.100). Make sure the address is unique on the network.
                      </div>
                    </div>
                  </label>
                  <input type="text" name="device_ip" id="device_ip" required placeholder="e.g. 192.168.1.100" />
                </div>

                <div class="form-group">
                  <label for="modbus_port">
                    Modbus TCP Port
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        TCP port for Modbus communication. Standard port is 502.
                      </div>
                    </div>
                  </label>
                  <select name="modbus_port" id="modbus_port" required>
                    <option value="502">502</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="port_name">
                    Port Name
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Communication port name in the SCADA system. Example: P14_BOARD1_PRJ3
                      </div>
                    </div>
                  </label>
                  <input type="text" name="port_name" id="port_name" placeholder="e.g. P14_BOARD1_PRJ3" />
                </div>

                <div class="form-group">
                  <label for="memory_tcp">
                    MEMORY
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        TRUE/FALSE
                      </div>
                    </div>
                  </label>
                  <select id="memory_tcp" name="memory">
                    <option value="TRUE">TRUE</option>
                    <option value="FALSE">FALSE</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="modbus-rtu-config" class="hidden">
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="gateway_address">
                    Gateway Address
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Gateway address of the device on the network.
                      </div>
                    </div>
                  </label>
                  <input type="text" name="gateway_address" id="gateway_address" placeholder="e.g. 192.168.1.100" />
                </div>

                <div class="form-group">
                  <label for="slave_id">
                    Slave ID
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                         Modbus RTU slave address (1-247). Each device on the serial bus must have a unique slave ID.
                      </div>
                    </div>
                  </label>
                  <input type="number" name="slave_id" id="slave_id" placeholder="7" min="1" max="247" />
                </div>

                <div class="form-group">
                  <label for="port_name_rtu">
                    Port Name
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Communication port name in the SCADA system. Example: P14_BOARD1_PRJ3
                      </div>
                    </div>
                  </label>
                  <input type="text" name="port_name_rtu" id="port_name_rtu" placeholder="e.g. P14_BOARD1_PRJ3" />
                </div>

                <div class="form-group">
                  <label for="memory_rtu">
                    MEMORY
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        TRUE/FALSE
                      </div>
                    </div>
                  </label>
                  <select id="memory_rtu" name="memory_rtu">
                    <option value="TRUE">TRUE</option>
                    <option value="FALSE">FALSE</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="serial_port">
                    Serial Port
                    <div class="info-icon">
                      i
                      <div class="tooltip">
                        Serial communication port (e.g. COM1, COM2, /dev/ttyS0). This is the physical port on the computer or gateway.
                      </div>
                    </div>
                  </label>
                  <input type="text" name="serial_port" id="serial_port" placeholder="e.g. COM1" />
                </div>
              </div>

              <div class="advanced-options-toggle" onclick="toggleAdvancedOptions()">
                <div class="checkbox-container">
                  <input type="checkbox" id="advancedOptionsCheckbox">
                </div>
                <label for="advancedOptionsCheckbox">Advanced Options</label>
              </div>

              <div id="advancedOptionsContent" class="advanced-options-content">
                <div class="form-grid-2">
                  <div class="form-group">
                    <label for="baud_rate">
                      Baud Rate
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Serial communication speed in bits per second. Common values: 9600, 19200, 38400, 57600, 115200.
                        </div>
                      </div>
                    </label>
                    <select name="baud_rate" id="baud_rate" disabled>
                      <option value="9600">9600</option>
                      <option value="19200">19200</option>
                      <option value="38400" selected>38400</option>
                      <option value="57600">57600</option>
                      <option value="115200">115200</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="data_bits">
                      Data Bits
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Number of data bits per character. Standard is 8 bits.
                        </div>
                      </div>
                    </label>
                    <select name="data_bits" id="data_bits" disabled>
                      <option value="7">7</option>
                      <option value="8" selected>8</option>
                    </select>
                  </div>

                                    <div class="form-group">
                    <label for="parity">
                      Parity
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Error checking method. None = no parity, Even = even parity, Odd = odd parity.
                        </div>
                      </div>
                    </label>
                    <select name="parity" id="parity" disabled>
                      <option value="None" selected>None</option>
                      <option value="Even">Even</option>
                      <option value="Odd">Odd</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="stop_bits">
                      Stop Bits
                      <div class="info-icon">
                        i
                        <div class="tooltip">
                          Number of stop bits. Standard is 1 stop bit.
                        </div>
                      </div>
                    </label>
                    <select name="stop_bits" id="stop_bits" disabled>
                      <option value="1" selected>1</option>
                      <option value="2">2</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="protocol">
                Protocol
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Communication protocol used to connect to the device.
                  </div>
                </div>
              </label>
              <select name="protocol" id="protocol" required>
                <option value="Modbus TCP">Modbus TCP/IP</option>
              </select>
            </div>
          </div>

          <div class="config-section hidden" id="iec-config">
            <h3>IEC 61850 Network Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="iec_device_ip">
                  Device IP Address
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      IP address of the IEC 61850 device. Must be in IPv4 format (e.g. 192.168.1.100). Ensure unique addressing on the substation network.
                    </div>
                  </div>
                </label>
                <input type="text" name="iec_device_ip" id="iec_device_ip" placeholder="e.g. 192.168.1.100" />
              </div>

              <div class="form-group">
                <label for="iec_port">
                  IEC Port
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      TCP port for IEC 61850 communication. Standard port is 102 for MMS services. Can be customized if needed.
                    </div>
                  </div>
                </label>
                <input type="number" name="iec_port" id="iec_port" placeholder="102" value="102" min="1" max="65535" />
              </div>

              <div class="form-group">
                <label for="ied_name">
                  IED Name
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Intelligent Electronic Device name as defined in the SCL configuration. Must match the IED name in the substation configuration file.
                    </div>
                  </div>
                </label>
                <input type="text" name="ied_name" id="ied_name" placeholder="e.g. PROT_RELAY_01" />
              </div>

              <div class="form-group">
                <label for="access_point">
                  Access Point
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Access Point name for the IED communication interface. Typically defined in the IED configuration (e.g. S1, AP1, ETH1).
                    </div>
                  </div>
                </label>
                <input type="text" name="access_point" id="access_point" placeholder="e.g. S1" />
              </div>

              <div class="form-group">
                <label for="logical_device">
                  Logical Device
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Logical Device name within the IED. Represents a logical grouping of functions (e.g. LD0, PROT, CTRL).
                    </div>
                  </div>
                </label>
                <input type="text" name="logical_device" id="logical_device" placeholder="e.g. LD0" />
              </div>

              <div class="form-group">
                <label for="report_control">
                  Report Control Block
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Name of the Report Control Block (RCB) for data reporting. Used for unbuffered or buffered reporting of data changes and events.
                    </div>
                  </div>
                </label>
                <input type="text" name="report_control" id="report_control" placeholder="e.g. brcb01" />
              </div>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>

          <div class="button-group">
            <input type="file" id="cidFile" class="file-input hidden" accept=".cid" />
            <label for="cidFile" class="file-input-label hidden" id="cidInputLabel">Load CID</label>

            <button type="button" class="btn btn-success" id="saveDeviceBtn" onclick="saveDevice()">Save Device</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
            <button type="button" class="btn btn-primary" id="generateCSVBtn" onclick="generateCSV()">Generate CSV Files</button>
          </div>
        </form>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Generating configuration files</p>
        </div>
      </div>

      <div class="tab-content" id="variables">
        <div class="config-section">
          <h3>Variable Configuration</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label for="variable_name">
                Variable Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Name of the process variable. Use descriptive names like ActivePower, Voltage, Temperature. No spaces or special characters.
                  </div>
                </div>
              </label>
              <input type="text" id="variable_name" placeholder="e.g. ActivePower" />
            </div>

            <div class="form-group">
              <label for="variable_type">
                Variable Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Variable type: Analog (continuous values), Digital (binary values 0/1)
                  </div>
                </div>
              </label>
              <select id="variable_type">
                <option value="analog">Analog</option>
                <option value="digital">Digital</option>
              </select>
            </div>

            <div class="form-group">
              <label for="data_type">
                Data Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Data type: Float (floating point numbers), Integer (whole numbers), Boolean (true/false), String (text).
                  </div>
                </div>
              </label>
              <select id="data_type">
                <option value="float">Float</option>
                <option value="int">Integer</option>
                <option value="bool">Boolean</option>
                <option value="string">String</option>
              </select>
            </div>

            <div class="form-group">
              <label for="unit">
                Unit
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Unit of measurement for the variable. Examples: kW, V, A, °C, Hz, %
                  </div>
                </div>
              </label>
              <input type="text" id="unit" placeholder="e.g. kW" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" id="addVariableBtn" onclick="addVariable()">Add Variable</button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Variable Name</th>
                <th>Type</th>
                <th>Data Type</th>
                <th>Unit</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="variableTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="alarms">
        <div class="config-section">
          <h3>Alarms Configuration</h3>
          <div class="form-grid-3">
            <div class="form-group">
              <label for="alarm_name">
                Alarm Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Name for the alarm. Use clear naming convention like PowerFailure24V, HighTemperature, CommLoss
                  </div>
                </div>
              </label>
              <input type="text" id="alarm_name" placeholder="e.g. PowerFailure24V" />
            </div>

            <div class="form-group">
              <label for="alarm_type">
                Alarm Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Alarm type: Analog, Digital, Advanced
                  </div>
                </div>
              </label>
              <select id="alarm_type">
                <option value="analog">Analog</option>
                <option value="digital">Digital</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>

            <div class="form-group">
              <label for="category">
                Category
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Priority level: Low (informational), Medium (warning), High (critical), Event (status change)
                  </div>
                </div>
              </label>
              <select id="category">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="event">Event</option>
              </select>
            </div>

            <div class="form-group">
              <label for="alarm_tag">
                Alarm Tag
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Tag name associated with the alarm. Links alarm to specific data point or signal.
                  </div>
                </div>
              </label>
              <input type="text" id="alarm_tag" placeholder="e.g. User_Event" />
            </div>

            <div class="form-group">
              <label for="equipment">
                Equipment
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Equipment hierarchy path. Defines where the alarm belongs in the system structure.
                  </div>
                </div>
              </label>
              <input type="text" id="equipment" placeholder="e.g. Virtual.System" />
            </div>

            <div class="form-group">
              <label for="item_name_alarm">
                Item Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Specific item name that triggers the alarm (e.g. CommHealth, Temperature, Voltage)
                  </div>
                </div>
              </label>
              <input type="text" id="item_name_alarm" placeholder="e.g. CommHealth" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" id="addAlarmBtn" onclick="addAlarm()">Add Alarm</button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Alarm Name</th>
                <th>Type</th>
                <th>Category</th>
                <th>Alarm Tag</th>
                <th>Equipment</th>
                <th>Item Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="alarmTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="trends">
        <div class="config-section">
          <h3>Trends Configuration</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label for="tag_description">
                Tag Description
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Text for the trend tag. Should clearly identify what is being trended (e.g. "Phase A Current", "Active Power Output").
                  </div>
                </div>
              </label>
              <input type="text" id="tag_description" placeholder="e.g. Current A" />
            </div>

            <div class="form-group">
              <label for="trend_types">
                Trend Types
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Trend collection type: Event (on change), Periodic (time-based), Periodic-Event (both time and change based)
                  </div>
                </div>
              </label>
              <select id="trend_types">
                <option value="event">Event</option>
                <option value="periodic">Periodic</option>
                <option value="periodic-event">Periodic-Event</option>
              </select>
            </div>

            <div class="form-group">
              <label for="tag_name">
                Tag Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Full tag name path including logical node and data object (IEC 61850 format: MMXU1\A\phsA)
                  </div>
                </div>
              </label>
              <input type="text" id="tag_name" placeholder="e.g. MMXU1\A\phsA" />
            </div>

            <div class="form-group">
              <label for="item_name_trend">
                Item Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Short item identifier for the trending parameter (e.g. Ia, Vab, P, Q, F)
                  </div>
                </div>
              </label>
              <input type="text" id="item_name_trend" placeholder="e.g. Ia" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" id="addTrendBtn" onclick="addTrend()">Add Trend</button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Tag Description</th>
                <th>Trend Types</th>
                <th>Tag Name</th>
                <th>Item Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="trendTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


<script>

let currentProtocol = 'modbus';
let currentModbusVariant = 'tcp';
let devices = [];
let variables = [];
let alarms = [];
let trends = [];
let currentDevice = null;
let validationErrors = {};

const validationRules = {
    device_name: {
        required: true,
        minLength: 2,
        maxLength: 50,
        pattern: /^[a-zA-Z_][a-zA-Z0-9_-]*$/,
        message: 'Device name must start with letter or underscore, 2-50 characters, alphanumeric, underscore, or dash only'
    },
    device_type: {
        required: true,
        message: 'Please select a device type'
    },
    tag_prefix: {
        required: true,
        minLength: 1,
        maxLength: 10,
        pattern: /^[A-Z_][A-Z0-9_]*$/,
        message: 'Tag prefix must start with uppercase letter or underscore, contain only uppercase letters, numbers, and underscores'
    },
    io_device: {
        required: true,
        message: 'Please select an I/O device'
    },
    device_ip: {
        required: true,
        pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
        message: 'Please enter a valid IP address (e.g., 192.168.1.100)'
    },
    modbus_port: {
        required: true,
        min: 1,
        max: 65535,
        message: 'Port must be between 1 and 65535'
    },
    port_name: {
        required: true,
        minLength: 1,
        maxLength: 20,
        message: 'Port name is required (1-20 characters)'
    },
    unit_number: {
        required: true,
        min: 1,
        max: 247,
        message: 'Unit number must be between 1 and 247'
    },
    gateway_address: {
        required: true,
        pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
        message: 'Please enter a valid gateway IP address'
    },
    slave_id: {
        required: true,
        min: 1,
        max: 247,
        message: 'Slave ID must be between 1 and 247'
    },
    serial_port: {
        required: true,
        pattern: /^COM\d+$|^\/dev\/tty[A-Za-z0-9]+$/,
        message: 'Enter valid serial port (e.g., COM1, /dev/ttyUSB0)'
    },
    baud_rate: {
        required: false,
        enum: ['9600', '19200', '38400', '57600', '115200'],
        message: 'Please select a valid baud rate'
    },
    iec_device_ip: {
        required: true,
        pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
        message: 'Please enter a valid IEC device IP address'
    },
    iec_port: {
        required: true,
        min: 1,
        max: 65535,
        message: 'IEC port must be between 1 and 65535'
    },
    ied_name: {
        required: true,
        minLength: 1,
        maxLength: 64,
        pattern: /^[a-zA-Z_][a-zA-Z0-9_]*$/,
        message: 'IED name must start with letter or underscore, contain only letters, numbers, and underscores'
    },
    access_point: {
        required: true,
        minLength: 1,
        maxLength: 32,
        message: 'Access point is required (1-32 characters)'
    },
    logical_device: {
        required: true,
        minLength: 1,
        maxLength: 64,
        message: 'Logical device is required (1-64 characters)'
    },
    port_name_rtu: {
        required: true,
        minLength: 1,
        maxLength: 20,
        message: 'Port name is required (1-20 characters)'
    },
    variable_name: {
        required: true,
        minLength: 1,
        maxLength: 50,
        pattern: /^[a-zA-Z_][a-zA-Z0-9_]*$/,
        message: 'Variable name must start with letter or underscore, contain only letters, numbers, and underscores'
    },
    variable_type: {
        required: true,
        message: 'Please select a variable type'
    },
    data_type: {
        required: true,
        message: 'Please select a data type'
    },
    unit: {
        required: true,
        minLength: 1,
        maxLength: 20,
        message: 'Unit is required (1-20 characters)'
    },
    alarm_name: {
        required: true,
        minLength: 1,
        maxLength: 50,
        pattern: /^[a-zA-Z_][a-zA-Z0-9_\s]*$/,
        message: 'Alarm name must start with letter or underscore, contain only letters, numbers, underscores, and spaces'
    },
    alarm_type: {
        required: true,
        message: 'Please select an alarm type'
    },
    category: {
        required: true,
        message: 'Please select a category'
    },
    alarm_tag: {
        required: true,
        minLength: 1,
        maxLength: 30,
        message: 'Alarm tag is required (1-30 characters)'
    },
    equipment: {
        required: true,
        minLength: 1,
        maxLength: 30,
        message: 'Equipment is required (1-30 characters)'
    },
    item_name_alarm: {
        required: true,
        minLength: 1,
        maxLength: 30,
        message: 'Item name is required (1-30 characters)'
    },
    tag_description: {
        required: true,
        minLength: 3,
        maxLength: 100,
        message: 'Tag description must be 3-100 characters long'
    },
    trend_types: {
        required: true,
        message: 'Please select a trend type'
    },
    tag_name: {
        required: true,
        minLength: 1,
        maxLength: 50,
        message: 'Tag name is required (1-50 characters)'
    },
    item_name_trend: {
        required: true,
        minLength: 1,
        maxLength: 30,
        message: 'Item name is required (1-30 characters)'
    }
};

document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    updateDeviceCounter();
    loadDevicesFromStorage();
    loadVariablesFromStorage();
    loadAlarmsFromStorage();
    loadTrendsFromStorage();
    setupValidation();

    document.getElementById('csvFile').addEventListener('change', loadCSV);
    document.getElementById('variablesCsvFile').addEventListener('change', loadVariablesCSV);
    document.getElementById('alarmsCsvFile').addEventListener('change', loadAlarmsCSV);
    document.getElementById('trendsCsvFile').addEventListener('change', loadTrendsCSV);
    document.getElementById('cidFile').addEventListener('change', loadCID);
});

function setupValidation() {
    const form = document.getElementById('deviceForm');
    if (!form) return;

    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => {
        field.addEventListener('input', function() {
            validateField(this);
            updateFormButtons();
            updateProgressBar();
        });

        field.addEventListener('change', function() {
            validateField(this);
            updateFormButtons();
            updateProgressBar();
        });

        field.addEventListener('blur', function() {
            validateField(this);
            updateFormButtons();
        });

        field.addEventListener('focus', function() {
            clearFieldError(this);
        });
    });

    setupSubFormValidation();
    updateFormButtons();
}

function setupSubFormValidation() {
    const variableFields = ['variable_name', 'variable_type', 'data_type', 'unit'];
    variableFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('change', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('blur', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('focus', function() {
                clearFieldError(this);
            });
        }
    });

    const alarmFields = ['alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm'];
    alarmFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('change', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('blur', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('focus', function() {
                clearFieldError(this);
            });
        }
    });

    const trendFields = ['tag_description', 'trend_types', 'tag_name', 'item_name_trend'];
    trendFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('change', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('blur', function() {
                validateField(this);
                updateFormButtons();
            });
            field.addEventListener('focus', function() {
                clearFieldError(this);
            });
        }
    });
}

function validateField(field) {
    const fieldName = field.name || field.id;
    const value = field.value.trim();
    const rules = validationRules[fieldName];

    if (!rules) return true;

    if (!isFieldVisible(field) && !isSubFormField(fieldName)) {
        delete validationErrors[fieldName];
        clearFieldError(field);
        return true;
    }

    let isValid = true;
    let errorMessage = '';

    if (rules.required && !value) {
        isValid = false;
        errorMessage = `${getFieldLabel(field)} is required`;
    }

    if (value) {
        if (rules.minLength && value.length < rules.minLength) {
            isValid = false;
            errorMessage = `${getFieldLabel(field)} must be at least ${rules.minLength} characters`;
        }

        if (rules.maxLength && value.length > rules.maxLength) {
            isValid = false;
            errorMessage = `${getFieldLabel(field)} must not exceed ${rules.maxLength} characters`;
        }

        if (rules.pattern && !rules.pattern.test(value)) {
            isValid = false;
            errorMessage = rules.message || `${getFieldLabel(field)} format is invalid`;
        }

        if (rules.min !== undefined || rules.max !== undefined) {
            const numValue = parseInt(value);
            if (isNaN(numValue)) {
                isValid = false;
                errorMessage = `${getFieldLabel(field)} must be a valid number`;
            } else {
                if (rules.min !== undefined && numValue < rules.min) {
                    isValid = false;
                    errorMessage = `${getFieldLabel(field)} must be at least ${rules.min}`;
                }
                if (rules.max !== undefined && numValue > rules.max) {
                    isValid = false;
                    errorMessage = `${getFieldLabel(field)} must not exceed ${rules.max}`;
                }
            }
        }

        if (rules.enum && !rules.enum.includes(value)) {
            isValid = false;
            errorMessage = rules.message || `${getFieldLabel(field)} has invalid value`;
        }
    }

    if (fieldName.startsWith('baud_rate') || fieldName.startsWith('data_bits') ||
        fieldName.startsWith('parity') || fieldName.startsWith('stop_bits')) {
        const advancedEnabled = document.getElementById('advancedOptionsCheckbox')?.checked;
        if (!advancedEnabled) {
            delete validationErrors[fieldName];
            clearFieldError(field);
            return true;
        }
    }

    if (!isValid) {
        validationErrors[fieldName] = errorMessage;
        showFieldError(field, errorMessage);
    } else {
        delete validationErrors[fieldName];
        clearFieldError(field);
    }

    return isValid;
}

function isSubFormField(fieldName) {
    const subFormFields = [
        'variable_name', 'variable_type', 'data_type', 'unit',
        'alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm',
        'tag_description', 'trend_types', 'tag_name', 'item_name_trend'
    ];
    return subFormFields.includes(fieldName);
}

function isFieldVisible(field) {
    if (field.offsetParent === null) return false;

    const fieldName = field.name || field.id;

    if (currentProtocol === 'modbus') {
        if (fieldName.startsWith('iec_')) return false;

        if (currentModbusVariant === 'tcp') {
            if (['gateway_address', 'slave_id', 'port_name_rtu', 'memory_rtu', 'serial_port',
                 'baud_rate', 'data_bits', 'parity', 'stop_bits'].includes(fieldName)) {
                return false;
            }
        } else {
            if (['device_ip', 'modbus_port', 'port_name', 'memory_tcp', 'unit_number'].includes(fieldName)) {
                return false;
            }
        }
    } else if (currentProtocol === 'iec') {
        if (['device_ip', 'modbus_port', 'port_name', 'unit_number', 'memory_tcp',
             'gateway_address', 'slave_id', 'port_name_rtu', 'memory_rtu', 'serial_port',
             'baud_rate', 'data_bits', 'parity', 'stop_bits'].includes(fieldName)) {
            return false;
        }
    }

    return true;
}

function getFieldLabel(field) {
    const labels = {
        device_name: 'Device Name',
        device_type: 'Device Type',
        tag_prefix: 'Tag Prefix',
        io_device: 'I/O Device',
        device_ip: 'Device IP Address',
        modbus_port: 'Modbus Port',
        port_name: 'Port Name',
        unit_number: 'Unit Number',
        gateway_address: 'Gateway Address',
        slave_id: 'Slave ID',
        port_name_rtu: 'Port Name',
        serial_port: 'Serial Port',
        baud_rate: 'Baud Rate',
        iec_device_ip: 'IEC Device IP',
        iec_port: 'IEC Port',
        ied_name: 'IED Name',
        access_point: 'Access Point',
        logical_device: 'Logical Device',
        variable_name: 'Variable Name',
        variable_type: 'Variable Type',
        data_type: 'Data Type',
        unit: 'Unit',
        alarm_name: 'Alarm Name',
        alarm_type: 'Alarm Type',
        category: 'Category',
        alarm_tag: 'Alarm Tag',
        equipment: 'Equipment',
        item_name_alarm: 'Item Name',
        tag_description: 'Tag Description',
        trend_types: 'Trend Type',
        tag_name: 'Tag Name',
        item_name_trend: 'Item Name'
    };

    return labels[field.name || field.id] || (field.name || field.id).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function showFieldError(field, message) {
    field.classList.add('field-error');

    const existingError = field.parentNode.querySelector('.error-message');
    if (existingError) {
        existingError.remove();
    }

    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    errorDiv.style.cssText = `
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 4px;
        display: flex;
        align-items: center;
        animation: slideDown 0.3s ease;
    `;

    const icon = document.createElement('span');
    icon.style.marginRight = '4px';
    errorDiv.insertBefore(icon, errorDiv.firstChild);

    field.parentNode.insertBefore(errorDiv, field.nextSibling);

    field.style.cssText = `
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        background-color: rgba(220, 53, 69, 0.05) !important;
    `;
}

function clearFieldError(field) {
    field.classList.remove('field-error');

    const errorMessage = field.parentNode.querySelector('.error-message');
    if (errorMessage) {
        errorMessage.remove();
    }

    field.style.cssText = '';
}

function isVariableFormComplete() {
    const requiredFields = ['variable_name', 'variable_type', 'data_type', 'unit'];

    const allFieldsFilled = requiredFields.every(fieldName => {
        const field = document.getElementById(fieldName);
        return field && field.value.trim() !== '';
    });

    const hasVariableErrors = requiredFields.some(fieldName =>
        validationErrors.hasOwnProperty(fieldName)
    );

    return allFieldsFilled && !hasVariableErrors;
}

function isAlarmFormComplete() {
    const requiredFields = ['alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm'];

    const allFieldsFilled = requiredFields.every(fieldName => {
        const field = document.getElementById(fieldName);
        return field && field.value.trim() !== '';
    });

    const hasAlarmErrors = requiredFields.some(fieldName =>
        validationErrors.hasOwnProperty(fieldName)
    );

    return allFieldsFilled && !hasAlarmErrors;
}

function isTrendFormComplete() {
    const requiredFields = ['tag_description', 'trend_types', 'tag_name', 'item_name_trend'];

    const allFieldsFilled = requiredFields.every(fieldName => {
        const field = document.getElementById(fieldName);
        return field && field.value.trim() !== '';
    });

    const hasTrendErrors = requiredFields.some(fieldName =>
        validationErrors.hasOwnProperty(fieldName)
    );

    return allFieldsFilled && !hasTrendErrors;
}


function getMainFormRequiredFields() {
    const requiredFields = ['device_name', 'device_type', 'tag_prefix', 'io_device'];

    if (currentProtocol === 'modbus') {
        if (currentModbusVariant === 'tcp') {
            requiredFields.push('device_ip', 'modbus_port', 'port_name', 'memory_tcp');
        } else if (currentModbusVariant === 'rtu') {
            requiredFields.push('gateway_address', 'slave_id', 'port_name_rtu', 'serial_port', 'memory_rtu');


            const advancedEnabled = document.getElementById('advancedOptionsCheckbox')?.checked;
            if (advancedEnabled) {
                requiredFields.push('baud_rate', 'data_bits', 'parity', 'stop_bits');
            }
        }
    } else if (currentProtocol === 'iec') {
        requiredFields.push('iec_device_ip', 'iec_port', 'ied_name', 'access_point', 'logical_device');
    }

    return requiredFields;
}

function isMainFormComplete() {
    const requiredFields = getMainFormRequiredFields();

    return requiredFields.every(fieldName => {
        const field = document.getElementById(fieldName);
        if (!field) {
            console.warn(`Field ${fieldName} not found`);
            return false;
        }
        const isVisible = isFieldVisible(field);
        const hasValue = field.value && field.value.trim() !== '';


        if (!isVisible) {
            return true;
        }

        return hasValue;
    });
}

function hasMainFormValidationErrors() {
    const mainFormFields = getMainFormRequiredFields();

    return mainFormFields.some(fieldName => {
        const field = document.getElementById(fieldName);
        if (!field || !isFieldVisible(field)) {
            return false;
        }
        return validationErrors.hasOwnProperty(fieldName);
    });
}


function updateFormButtons() {
    const saveButton = document.querySelector('button[onclick="saveDevice()"]');
    const generateButton = document.querySelector('button[onclick="generateCSV()"]');
    const addVariableButton = document.querySelector('button[onclick="addVariable()"]');
    const addAlarmButton = document.querySelector('button[onclick="addAlarm()"]');
    const addTrendButton = document.querySelector('button[onclick="addTrend()"]');

    const isFormComplete = isMainFormComplete();
    const hasMainFormErrors = hasMainFormValidationErrors();

    console.log('Form validation check:', {
        isFormComplete,
        hasMainFormErrors,
        currentProtocol,
        currentModbusVariant,
        requiredFields: getMainFormRequiredFields()
    });

    if (saveButton) {
        if (!isFormComplete || hasMainFormErrors) {
            saveButton.disabled = true;
            saveButton.style.cssText = `
                background-color: #6c757d !important;
                border-color: #6c757d !important;
                cursor: not-allowed !important;
                opacity: 0.6 !important;
            `;

            if (hasMainFormErrors) {
                saveButton.title = 'Please fix validation errors';
            } else {
                const missingFields = getMainFormRequiredFields().filter(fieldName => {
                    const field = document.getElementById(fieldName);
                    return field && isFieldVisible(field) && (!field.value || field.value.trim() === '');
                });
                saveButton.title = `Please complete: ${missingFields.join(', ')}`;
            }
        } else {
            saveButton.disabled = false;
            saveButton.style.cssText = `
                background-color: #28a745 !important;
                border-color: #28a745 !important;
                cursor: pointer !important;
                opacity: 1 !important;
            `;
            saveButton.title = 'Save device configuration';
        }
    }

    if (generateButton) {
        if (devices.length === 0) {
            generateButton.disabled = true;
            generateButton.style.cssText = `
                background-color: #6c757d !important;
                border-color: #6c757d !important;
                cursor: not-allowed !important;
                opacity: 0.6 !important;
            `;
            generateButton.title = 'Save at least one device to generate CSV';
        } else {
            generateButton.disabled = false;
            generateButton.style.cssText = '';
            generateButton.title = 'Generate CSV files';
        }
    }

    if (addVariableButton) {
        const isComplete = isVariableFormComplete();

        if (!isComplete) {
            addVariableButton.disabled = true;
            addVariableButton.style.cssText = `
                background-color: #6c757d !important;
                cursor: not-allowed !important;
                opacity: 0.6 !important;
            `;
            addVariableButton.title = 'Please complete all variable fields';
        } else {
            addVariableButton.disabled = false;
            addVariableButton.style.cssText = '';
            addVariableButton.title = 'Add variable';
        }
    }

    if (addAlarmButton) {
        const isComplete = isAlarmFormComplete();

        if (!isComplete) {
            addAlarmButton.disabled = true;
            addAlarmButton.style.cssText = `
                background-color: #6c757d !important;
                cursor: not-allowed !important;
                opacity: 0.6 !important;
            `;
            addAlarmButton.title = 'Please complete all alarm fields';
        } else {
            addAlarmButton.disabled = false;
            addAlarmButton.style.cssText = '';
            addAlarmButton.title = 'Add alarm';
        }
    }

    if (addTrendButton) {
        const isComplete = isTrendFormComplete();

        if (!isComplete) {
            addTrendButton.disabled = true;
            addTrendButton.style.cssText = `
                background-color: #6c757d !important;
                cursor: not-allowed !important;
                opacity: 0.6 !important;
            `;
            addTrendButton.title = 'Please complete all trend fields';
        } else {
            addTrendButton.disabled = false;
            addTrendButton.style.cssText = '';
            addTrendButton.title = 'Add trend';
        }
    }
}

function initializeForm() {
    selectProtocol('modbus');
    selectModbusVariant('tcp');

    const advancedCheckbox = document.getElementById('advancedOptionsCheckbox');
    if (advancedCheckbox) {
        advancedCheckbox.checked = false;
        toggleAdvancedOptions();
    }
}

function showTab(tabName, event) {
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => tab.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));

    if (event && event.target) {
        event.target.classList.add('active');
    }

    const targetContent = document.getElementById(tabName);
    if (targetContent) {
        targetContent.classList.add('active');
    }
}

function selectProtocol(protocol) {
    currentProtocol = protocol;

    const protocolButtons = document.querySelectorAll('.protocol-btn');
    protocolButtons.forEach(btn => btn.classList.remove('active'));

    protocolButtons.forEach(btn => {
        if ((protocol === 'modbus' && btn.textContent.trim().includes('Modbus')) ||
            (protocol === 'iec' && btn.textContent.trim().includes('IEC'))) {
            btn.classList.add('active');
        }
    });

    const modbusConfig = document.getElementById('modbus-config');
    const iecConfig = document.getElementById('iec-config');
    const cidInputLabel = document.getElementById('cidInputLabel');
    const cidFile = document.getElementById('cidFile');

    if (protocol === 'modbus') {
        if (modbusConfig) modbusConfig.classList.remove('hidden');
        if (iecConfig) iecConfig.classList.add('hidden');
        if (cidInputLabel) cidInputLabel.classList.add('hidden');
        if (cidFile) cidFile.classList.add('hidden');

        const protocolSelect = document.getElementById('protocol');
        if (protocolSelect) {
            if (currentModbusVariant === 'tcp') {
                protocolSelect.innerHTML = '<option value="Modbus TCP">Modbus TCP/IP</option>';
            } else {
                protocolSelect.innerHTML = '<option value="Modbus RTU">Modbus RTU</option>';
            }
        }
    } else if (protocol === 'iec') {
        if (modbusConfig) modbusConfig.classList.add('hidden');
        if (iecConfig) iecConfig.classList.remove('hidden');
        if (cidInputLabel) cidInputLabel.classList.remove('hidden');
        if (cidFile) cidFile.classList.remove('hidden');

        const protocolSelect = document.getElementById('protocol');
        if (protocolSelect) {
            protocolSelect.innerHTML = '<option value="IEC61850">IEC 61850</option>';
        }
    }

    clearProtocolErrors();
    updateFormButtons();
    updateProgressBar();
}

function clearProtocolErrors() {
    const protocolFields = [
        'device_ip', 'modbus_port', 'port_name', 'unit_number',
        'gateway_address', 'slave_id', 'port_name_rtu', 'serial_port',
        'iec_device_ip', 'iec_port', 'ied_name', 'access_point', 'logical_device'
    ];

    protocolFields.forEach(fieldName => {
        delete validationErrors[fieldName];
        const field = document.getElementById(fieldName);
        if (field) {
            clearFieldError(field);
        }
    });
}

function selectModbusVariant(variant) {
    currentModbusVariant = variant;

    const variantButtons = document.querySelectorAll('.modbus-variant-btn');
    variantButtons.forEach(btn => btn.classList.remove('active'));

    variantButtons.forEach(btn => {
        if ((variant === 'tcp' && btn.textContent.trim() === 'TCP/IP') ||
            (variant === 'rtu' && btn.textContent.trim() === 'RTU')) {
            btn.classList.add('active');
        }
    });

    const tcpConfig = document.getElementById('modbus-tcp-config');
    const rtuConfig = document.getElementById('modbus-rtu-config');

    if (variant === 'tcp') {
        if (tcpConfig) tcpConfig.classList.remove('hidden');
        if (rtuConfig) rtuConfig.classList.add('hidden');

        const protocolSelect = document.getElementById('protocol');
        if (protocolSelect) {
            protocolSelect.innerHTML = '<option value="Modbus TCP">Modbus TCP/IP</option>';
        }
    } else if (variant === 'rtu') {
        if (tcpConfig) tcpConfig.classList.add('hidden');
        if (rtuConfig) rtuConfig.classList.remove('hidden');

        const protocolSelect = document.getElementById('protocol');
        if (protocolSelect) {
            protocolSelect.innerHTML = '<option value="Modbus RTU">Modbus RTU</option>';
        }
    }

    clearProtocolErrors();
    updateFormButtons();
    updateProgressBar();
}

function toggleAdvancedOptions() {
    const checkbox = document.getElementById('advancedOptionsCheckbox');
    const content = document.getElementById('advancedOptionsContent');
    const baudRate = document.getElementById('baud_rate');
    const dataBits = document.getElementById('data_bits');
    const parity = document.getElementById('parity');
    const stopBits = document.getElementById('stop_bits');

    if (checkbox && checkbox.checked) {
        if (content) content.classList.add('enabled');
        if (baudRate) baudRate.disabled = false;
        if (dataBits) dataBits.disabled = false;
        if (parity) parity.disabled = false;
        if (stopBits) stopBits.disabled = false;
    } else {
        if (content) content.classList.remove('enabled');
        if (baudRate) baudRate.disabled = true;
        if (dataBits) dataBits.disabled = true;
        if (parity) parity.disabled = true;
        if (stopBits) stopBits.disabled = true;

        ['baud_rate', 'data_bits', 'parity', 'stop_bits'].forEach(fieldName => {
            delete validationErrors[fieldName];
            const field = document.getElementById(fieldName);
            if (field) clearFieldError(field);
        });
    }

    updateFormButtons();
}

function updateProgressBar() {
    const form = document.getElementById('deviceForm');
    if (!form) return;

    const requiredFields = form.querySelectorAll('input[required], select[required]');
    let filledFields = 0;
    let visibleRequiredFields = 0;

    requiredFields.forEach(field => {
        if (isFieldVisible(field)) {
            visibleRequiredFields++;
            if (field.value.trim() !== '' && !validationErrors[field.name || field.id]) {
                filledFields++;
            }
        }
    });

    const progress = visibleRequiredFields > 0 ? (filledFields / visibleRequiredFields) * 100 : 0;
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        progressFill.style.width = progress + '%';

        if (Object.keys(validationErrors).length > 0) {
            progressFill.style.backgroundColor = '#dc3545';
        } else if (progress === 100) {
            progressFill.style.backgroundColor = '#28a745';
        } else {
            progressFill.style.backgroundColor = '#007bff';
        }
    }

    const progressText = document.querySelector('.progress-text');
    if (progressText) {
        const errorCount = Object.keys(validationErrors).length;
        if (errorCount > 0) {
            progressText.textContent = `${errorCount} error${errorCount > 1 ? 's' : ''} to fix`;
            progressText.style.color = '#dc3545';
        } else if (progress === 100) {
            progressText.textContent = 'Form complete - ready to save';
            progressText.style.color = '#28a745';
        } else {
            progressText.textContent = `${Math.round(progress)}% complete`;
            progressText.style.color = '#007bff';
        }
    }
}

function addVariable() {
    if (!isVariableFormComplete()) {
        showAlert('Please complete all variable fields before adding', 'error');
        return;
    }

    const name = document.getElementById('variable_name');
    const type = document.getElementById('variable_type');
    const dataType = document.getElementById('data_type');
    const unit = document.getElementById('unit');

    if (variables.some(v => v.variable_name.toLowerCase() === name.value.trim().toLowerCase())) {
        showAlert('Variable name already exists', 'error');
        showFieldError(name, 'This variable name is already used');
        return;
    }

    const variable = {
        id: Date.now().toString(),
        variable_name: name.value.trim(),
        variable_type: type.value,
        data_type: dataType.value,
        unit: unit.value.trim()
    };

    variables.push(variable);
    updateVariableTable();
    clearVariableForm();
    saveVariablesToStorage();
    showAlert('Variable added successfully!', 'success');
}

function updateVariableTable() {
    const tbody = document.getElementById('variableTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    variables.forEach(variable => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${variable.variable_name}</td>
            <td>${variable.variable_type}</td>
            <td>${variable.data_type}</td>
            <td>${variable.unit}</td>
            <td>
                <button class="btn btn-danger" onclick="removeVariable('${variable.id}')" style="background: #dc3545; padding: 6px 12px; font-size: 0.8rem;">Remove</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function removeVariable(id) {
    variables = variables.filter(v => v.id !== id);
    updateVariableTable();
    saveVariablesToStorage();
    showAlert('Variable removed successfully!', 'success');
}

function clearVariableForm() {
    const fields = ['variable_name', 'variable_type', 'data_type', 'unit'];

    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            if (field.tagName === 'SELECT') {
                field.selectedIndex = 0;
            } else {
                field.value = '';
            }
            clearFieldError(field);
            delete validationErrors[fieldId];
        }
    });

    updateFormButtons();
}

function addAlarm() {
    if (!isAlarmFormComplete()) {
        showAlert('Please complete all alarm fields before adding', 'error');
        return;
    }

    const name = document.getElementById('alarm_name');
    const type = document.getElementById('alarm_type');
    const category = document.getElementById('category');
    const tag = document.getElementById('alarm_tag');
    const equipment = document.getElementById('equipment');
    const itemName = document.getElementById('item_name_alarm');

    if (alarms.some(a => a.alarm_name.toLowerCase() === name.value.trim().toLowerCase())) {
        showAlert('Alarm name already exists', 'error');
        showFieldError(name, 'This alarm name is already used');
        return;
    }

    const alarm = {
        id: Date.now().toString(),
        alarm_name: name.value.trim(),
        alarm_type: type.value,
        category: category.value,
        alarm_tag: tag.value.trim(),
        equipment: equipment.value.trim(),
        item_name: itemName.value.trim()
    };

    alarms.push(alarm);
    updateAlarmTable();
    clearAlarmForm();
    saveAlarmsToStorage();
    showAlert('Alarm added successfully!', 'success');
}

function updateAlarmTable() {
    const tbody = document.getElementById('alarmTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    alarms.forEach(alarm => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${alarm.alarm_name}</td>
            <td>${alarm.alarm_type}</td>
            <td>${alarm.category}</td>
            <td>${alarm.alarm_tag}</td>
            <td>${alarm.equipment}</td>
            <td>${alarm.item_name}</td>
            <td>
                <button class="btn btn-danger" onclick="removeAlarm('${alarm.id}')" style="background: #dc3545; padding: 6px 12px; font-size: 0.8rem;">Remove</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function removeAlarm(id) {
    alarms = alarms.filter(a => a.id !== id);
    updateAlarmTable();
    saveAlarmsToStorage();
    showAlert('Alarm removed successfully!', 'success');
}

function clearAlarmForm() {
    const fields = ['alarm_name', 'alarm_type', 'category', 'alarm_tag', 'equipment', 'item_name_alarm'];

    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            if (field.tagName === 'SELECT') {
                field.selectedIndex = 0;
            } else {
                field.value = '';
            }
            clearFieldError(field);
            delete validationErrors[fieldId];
        }
    });

    updateFormButtons();
}

function addTrend() {
    if (!isTrendFormComplete()) {
        showAlert('Please complete all trend fields before adding', 'error');
        return;
    }

    const description = document.getElementById('tag_description');
    const type = document.getElementById('trend_types');
    const tagName = document.getElementById('tag_name');
    const itemName = document.getElementById('item_name_trend');

    if (trends.some(t => t.tag_description.toLowerCase() === description.value.trim().toLowerCase())) {
        showAlert('Tag description already exists', 'error');
        showFieldError(description, 'This tag description is already used');
        return;
    }

    const trend = {
        id: Date.now().toString(),
        tag_description: description.value.trim(),
        trend_types: type.value,
        tag_name: tagName.value.trim(),
        item_name: itemName.value.trim()
    };

    trends.push(trend);
    updateTrendTable();
    clearTrendForm();
    saveTrendsToStorage();
    showAlert('Trend added successfully!', 'success');
}

function updateTrendTable() {
    const tbody = document.getElementById('trendTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    trends.forEach(trend => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${trend.tag_description}</td>
            <td>${trend.trend_types}</td>
            <td>${trend.tag_name}</td>
            <td>${trend.item_name}</td>
            <td>
                <button class="btn btn-danger" onclick="removeTrend('${trend.id}')" style="background: #dc3545; padding: 6px 12px; font-size: 0.8rem;">Remove</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function removeTrend(id) {
    trends = trends.filter(t => t.id !== id);
    updateTrendTable();
    saveTrendsToStorage();
    showAlert('Trend removed successfully!', 'success');
}

function clearTrendForm() {
    const fields = ['tag_description', 'trend_types', 'tag_name', 'item_name_trend'];

    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            if (field.tagName === 'SELECT') {
                field.selectedIndex = 0;
            } else {
                field.value = '';
            }
            clearFieldError(field);
            delete validationErrors[fieldId];
        }
    });

    updateFormButtons();
}

function saveDevice() {
    if (!performCompleteValidation()) {
        showAlert('Please fix all validation errors before saving', 'error');
        return;
    }

    const form = document.getElementById('deviceForm');
    const formData = new FormData(form);

    const deviceName = formData.get('device_name');
    const existingDevice = devices.find(d => d.device_name.toLowerCase() === deviceName.toLowerCase() && (!currentDevice || d.id !== currentDevice.id));
    if (existingDevice) {
        const deviceNameField = document.getElementById('device_name');
        showFieldError(deviceNameField, 'Device name already exists');
        showAlert('Device name already exists. Please choose a different name.', 'error');
        return;
    }

    const device = {
        id: currentDevice ? currentDevice.id : Date.now().toString(),
        protocol: currentProtocol,
        modbusVariant: currentModbusVariant,
        device_name: deviceName,
        device_type: formData.get('device_type'),
        tag_prefix: formData.get('tag_prefix'),
        io_device: formData.get('io_device'),
        variables: [...variables],
        alarms: [...alarms],
        trends: [...trends]
    };

    if (currentProtocol === 'modbus') {
        if (currentModbusVariant === 'tcp') {
            device.device_ip = formData.get('device_ip');
            device.modbus_port = formData.get('modbus_port');
            device.port_name = formData.get('port_name');
            device.unit_number = formData.get('unit_number');
            device.memory = formData.get('memory');
        } else {
            device.gateway_address = formData.get('gateway_address');
            device.slave_id = formData.get('slave_id');
            device.port_name_rtu = formData.get('port_name_rtu');
            device.memory_rtu = formData.get('memory_rtu');
            device.serial_port = formData.get('serial_port');

            const advancedEnabled = document.getElementById('advancedOptionsCheckbox').checked;
            if (advancedEnabled) {
                device.baud_rate = formData.get('baud_rate');
                device.data_bits = formData.get('data_bits');
                device.parity = formData.get('parity');
                device.stop_bits = formData.get('stop_bits');
            }
        }
        device.protocol_name = formData.get('protocol');
    } else if (currentProtocol === 'iec') {
        device.iec_device_ip = formData.get('iec_device_ip');
        device.iec_port = formData.get('iec_port');
        device.ied_name = formData.get('ied_name');
        device.access_point = formData.get('access_point');
        device.logical_device = formData.get('logical_device');
        device.report_control = formData.get('report_control');
        device.protocol_name = 'IEC61850';
    }

    if (currentDevice) {
        const index = devices.findIndex(d => d.id === currentDevice.id);
        if (index !== -1) {
            devices[index] = device;
        }
    } else {
        devices.push(device);
    }

    saveDevicesToStorage();
    updateDeviceList();
    updateDeviceCounter();
    showAlert('Device saved successfully!', 'success');

    currentDevice = null;
}

function performCompleteValidation() {
    const form = document.getElementById('deviceForm');
    if (!form) return false;

    let isValid = true;
    validationErrors = {};

    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => {
        if (isFieldVisible(field)) {
            if (!validateField(field)) {
                isValid = false;
            }
        }
    });

    updateFormButtons();
    updateProgressBar();

    return isValid;
}

function resetForm() {
    const form = document.getElementById('deviceForm');
    if (form) form.reset();

    validationErrors = {};
    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => clearFieldError(field));

    variables = [];
    alarms = [];
    trends = [];
    currentDevice = null;

    updateVariableTable();
    updateAlarmTable();
    updateTrendTable();

    selectProtocol('modbus');
    selectModbusVariant('tcp');

    const advancedCheckbox = document.getElementById('advancedOptionsCheckbox');
    if (advancedCheckbox) {
        advancedCheckbox.checked = false;
        toggleAdvancedOptions();
    }

    updateFormButtons();
    updateProgressBar();
    showAlert('Form reset successfully!', 'success');
}

function generateCSV() {
    if (devices.length === 0) {
        showAlert('No devices to export. Please save at least one device first.', 'error');
        return;
    }

    showLoading(true);

    setTimeout(() => {
        try {
            generateEquipmentCSV();
            generateUnitsCSV();
            generateVariablesCSV();
            generateAlarmsCSV();
            generateTrendsCSV();

            showAlert('All CSV files generated successfully!', 'success');
        } catch (error) {
            console.error('Error generating CSV:', error);
            showAlert('Error generating CSV files: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }, 1000);
}

function generateEquipmentConfig() {
    if (devices.length === 0) {
        showAlert('No devices configured. Please save at least one device first.', 'error');
        return;
    }
    generateEquipmentCSV();
}

function generateUnitsConfig() {
    if (devices.length === 0) {
        showAlert('No devices configured. Please save at least one device first.', 'error');
        return;
    }
    generateUnitsCSV();
}

function generateEquipmentCSV() {
    const headers = ['ITEM_NAME', 'EQUIP_TYPE', 'COMMENT', 'CUSTOM01', 'CUSTOM02'];
    const rows = [headers.join(',')];

    devices.forEach(device => {
        const row = [
            device.device_name,
            device.device_type,
            `${device.device_type} - ${device.device_name}`,
            device.tag_prefix,
            device.io_device
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'EQUIP.csv');
}

function generateUnitsCSV() {
    const headers = ['UNIT_NAME', 'UNIT_TYPE', 'PORT_NAME', 'IP_ADDRESS', 'PROTOCOL', 'MEMORY', 'UNIT_NUMBER'];
    const rows = [headers.join(',')];

    devices.forEach(device => {
        if (device.protocol === 'modbus') {
            const row = [
                device.device_name,
                'PLC',
                device.modbusVariant === 'tcp' ? (device.port_name || '') : (device.port_name_rtu || ''),
                device.modbusVariant === 'tcp' ? (device.device_ip || '') : (device.gateway_address || ''),
                device.protocol_name || 'Modbus TCP',
                device.modbusVariant === 'tcp' ? (device.memory || 'TRUE') : (device.memory_rtu || 'TRUE'),
                device.modbusVariant === 'tcp' ? (device.unit_number || '1') : (device.slave_id || '1')
            ];
            rows.push(row.join(','));
        } else if (device.protocol === 'iec') {
            const row = [
                device.device_name,
                'IED',
                device.ied_name || '',
                device.iec_device_ip || '',
                'IEC61850',
                'TRUE',
                device.iec_port || '102'
            ];
            rows.push(row.join(','));
        }
    });

    downloadCSV(rows.join('\n'), 'UNITS.csv');
}

function generateVariablesCSV() {
    if (variables.length === 0) {
        showAlert('No variables configured', 'error');
        return;
    }

    const headers = ['VARIABLE_NAME', 'VARIABLE_TYPE', 'DATA_TYPE', 'UNIT'];
    const rows = [headers.join(',')];

    variables.forEach(variable => {
        const row = [
            variable.variable_name,
            variable.variable_type,
            variable.data_type,
            variable.unit
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'VARIABLES.csv');
}

function generateAlarmsCSV() {
    if (alarms.length === 0) {
        showAlert('No alarms configured', 'error');
        return;
    }

    const headers = ['ALARM_NAME', 'ALARM_TYPE', 'CATEGORY', 'ALARM_TAG', 'EQUIPMENT', 'ITEM_NAME'];
    const rows = [headers.join(',')];

    alarms.forEach(alarm => {
        const row = [
            alarm.alarm_name,
            alarm.alarm_type,
            alarm.category,
            alarm.alarm_tag,
            alarm.equipment,
            alarm.item_name
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'ALARMS.csv');
}

function generateTrendsCSV() {
    if (trends.length === 0) {
        showAlert('No trends configured', 'error');
        return;
    }

    const headers = ['TAG_DESCRIPTION', 'TREND_TYPES', 'TAG_NAME', 'ITEM_NAME'];
    const rows = [headers.join(',')];

    trends.forEach(trend => {
        const row = [
            trend.tag_description,
            trend.trend_types,
            trend.tag_name,
            trend.item_name
        ];
        rows.push(row.join(','));
    });

    downloadCSV(rows.join('\n'), 'TRENDS.csv');
}

function loadCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Please select a valid CSV file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                showAlert('CSV file appears to be empty or invalid', 'error');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());

            if (headers.includes('ITEM_NAME') && headers.includes('EQUIP_TYPE')) {
                loadEquipmentFromCSV(lines);
            } else if (headers.includes('UNIT_NAME') && headers.includes('PROTOCOL')) {
                loadUnitsFromCSV(lines);
            } else {
                showAlert('CSV format not recognized. Expected Equipment or Units format.', 'error');
                return;
            }

            showAlert('CSV loaded successfully!', 'success');
        } catch (error) {
            showAlert('Error loading CSV: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function loadVariablesCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Please select a valid CSV file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                showAlert('Variables CSV file appears to be empty', 'error');
                return;
            }

            variables = [];
            let errorCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = line.split(',').map(v => v.trim());

                    if (values[0] && values[0].length > 0) {
                        const variable = {
                            id: Date.now().toString() + i,
                            variable_name: values[0] || '',
                            variable_type: values[1] || 'analog',
                            data_type: values[2] || 'float',
                            unit: values[3] || ''
                        };
                        variables.push(variable);
                    } else {
                        errorCount++;
                    }
                }
            }

            updateVariableTable();
            saveVariablesToStorage();

            if (errorCount > 0) {
                showAlert(`Variables CSV loaded with ${errorCount} rows skipped due to missing names`, 'warning');
            } else {
                showAlert('Variables CSV loaded successfully!', 'success');
            }
        } catch (error) {
            showAlert('Error loading Variables CSV: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function loadAlarmsCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Please select a valid CSV file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                showAlert('Alarms CSV file appears to be empty', 'error');
                return;
            }

            alarms = [];
            let errorCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = line.split(',').map(v => v.trim());

                    if (values[0] && values[0].length > 0) {
                        const alarm = {
                            id: Date.now().toString() + i,
                            alarm_name: values[0] || '',
                            alarm_type: values[1] || 'analog',
                            category: values[2] || 'low',
                            alarm_tag: values[3] || '',
                            equipment: values[4] || '',
                            item_name: values[5] || ''
                        };
                        alarms.push(alarm);
                    } else {
                        errorCount++;
                    }
                }
            }

            updateAlarmTable();
            saveAlarmsToStorage();

            if (errorCount > 0) {
                showAlert(`Alarms CSV loaded with ${errorCount} rows skipped due to missing names`, 'warning');
            } else {
                showAlert('Alarms CSV loaded successfully!', 'success');
            }
        } catch (error) {
            showAlert('Error loading Alarms CSV: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function loadTrendsCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Please select a valid CSV file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                showAlert('Trends CSV file appears to be empty', 'error');
                return;
            }

            trends = [];
            let errorCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = line.split(',').map(v => v.trim());

                    if (values[0] && values[0].length > 0) {
                        const trend = {
                            id: Date.now().toString() + i,
                            tag_description: values[0] || '',
                            trend_types: values[1] || 'event',
                            tag_name: values[2] || '',
                            item_name: values[3] || ''
                        };
                        trends.push(trend);
                    } else {
                        errorCount++;
                    }
                }
            }

            updateTrendTable();
            saveTrendsToStorage();

            if (errorCount > 0) {
                showAlert(`Trends CSV loaded with ${errorCount} rows skipped due to missing descriptions`, 'warning');
            } else {
                showAlert('Trends CSV loaded successfully!', 'success');
            }
        } catch (error) {
            showAlert('Error loading Trends CSV: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function loadCID(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.cid')) {
        showAlert('Please select a valid CID file', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const cidContent = e.target.result;
            if (!cidContent.includes('<?xml') || !cidContent.includes('<SCL')) {
                showAlert('Invalid CID file format. Expected SCL XML format.', 'error');
                return;
            }

            showAlert('CID file loaded successfully!', 'success');
        } catch (error) {
            showAlert('Error loading CID file: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function updateDeviceList() {
    const deviceList = document.getElementById('deviceList');
    if (!deviceList) return;

    if (devices.length === 0) {
        deviceList.innerHTML = '<div class="placeholder-content"><p>No devices configured yet.</p></div>';
        return;
    }

    let html = '';
    devices.forEach(device => {
        html += `
            <div class="device-item" onclick="loadDevice('${device.id}')" style="
                background: rgba(255,255,255,0.1);
                margin: 10px 0;
                padding: 12px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='rgba(255,255,255,0.2)'"
               onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <div style="font-weight: bold; margin-bottom: 4px;">${device.device_name}</div>
                <div style="font-size: 0.9em; opacity: 0.8;">${device.device_type} - ${device.protocol.toUpperCase()}</div>
                <button onclick="event.stopPropagation(); removeDevice('${device.id}')" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.8em;
                    margin-top: 8px;
                    cursor: pointer;
                ">Remove</button>
            </div>
        `;
    });

    deviceList.innerHTML = html;
}

function loadDevice(deviceId) {
    const device = devices.find(d => d.id === deviceId);
    if (!device) return;

    currentDevice = device;

    validationErrors = {};
    const form = document.getElementById('deviceForm');
    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => clearFieldError(field));

    document.getElementById('device_name').value = device.device_name || '';
    document.getElementById('device_type').value = device.device_type || '';
    document.getElementById('tag_prefix').value = device.tag_prefix || '';
    document.getElementById('io_device').value = device.io_device || '';

    selectProtocol(device.protocol);

    if (device.protocol === 'modbus') {
        selectModbusVariant(device.modbusVariant || 'tcp');

        if (device.modbusVariant === 'tcp') {
            document.getElementById('device_ip').value = device.device_ip || '';
            document.getElementById('modbus_port').value = device.modbus_port || '502';
            document.getElementById('port_name').value = device.port_name || '';
            document.getElementById('unit_number').value = device.unit_number || '';
            document.getElementById('memory_tcp').value = device.memory || 'TRUE';
        } else {
            document.getElementById('gateway_address').value = device.gateway_address || '';
            document.getElementById('slave_id').value = device.slave_id || '';
            document.getElementById('port_name_rtu').value = device.port_name_rtu || '';
            document.getElementById('memory_rtu').value = device.memory_rtu || 'TRUE';
            document.getElementById('serial_port').value = device.serial_port || '';

            if (device.baud_rate) {
                document.getElementById('advancedOptionsCheckbox').checked = true;
                toggleAdvancedOptions();
                document.getElementById('baud_rate').value = device.baud_rate;
                document.getElementById('data_bits').value = device.data_bits || '8';
                document.getElementById('parity').value = device.parity || 'None';
                document.getElementById('stop_bits').value = device.stop_bits || '1';
            }
        }
    } else if (device.protocol === 'iec') {
        document.getElementById('iec_device_ip').value = device.iec_device_ip || '';
        document.getElementById('iec_port').value = device.iec_port || '102';
        document.getElementById('ied_name').value = device.ied_name || '';
        document.getElementById('access_point').value = device.access_point || '';
        document.getElementById('logical_device').value = device.logical_device || '';
        document.getElementById('report_control').value = device.report_control || '';
    }

    variables = device.variables || [];
    alarms = device.alarms || [];
    trends = device.trends || [];

    updateVariableTable();
    updateAlarmTable();
    updateTrendTable();
    updateFormButtons();
    updateProgressBar();

    showAlert('Device loaded successfully!', 'success');
}

function removeDevice(deviceId) {
    if (confirm('Are you sure you want to remove this device?')) {
        devices = devices.filter(d => d.id !== deviceId);
        saveDevicesToStorage();
        updateDeviceList();
        updateDeviceCounter();
        updateFormButtons();
        showAlert('Device removed successfully!', 'success');
    }
}

function updateDeviceCounter() {
    const counter = document.getElementById('deviceCounter');
    if (counter) {
        counter.textContent = devices.length;
    }
}

function saveDevicesToStorage() {
    console.log('Devices saved:', devices);
}

function loadDevicesFromStorage() {
    devices = [];
    updateDeviceList();
}

function saveVariablesToStorage() {
    console.log('Variables saved:', variables);
}

function loadVariablesFromStorage() {
    variables = [];
    updateVariableTable();
}

function saveAlarmsToStorage() {
    console.log('Alarms saved:', alarms);
}

function loadAlarmsFromStorage() {
    alarms = [];
    updateAlarmTable();
}

function saveTrendsToStorage() {
    console.log('Trends saved:', trends);
}

function loadTrendsFromStorage() {
    trends = [];
    updateTrendTable();
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');

    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
    alert.textContent = message;

    const container = document.querySelector('.container');
    if (container) {
        container.insertBefore(alert, container.firstChild);

        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 5000);
    }
}

function showLoading(show) {
    const loading = document.getElementById('loading');
    const form = document.getElementById('deviceForm');

    if (loading) {
        if (show) {
            loading.classList.add('show');
            if (form) form.style.display = 'none';
        } else {
            loading.classList.remove('show');
            if (form) form.style.display = 'block';
        }
    }
}

function loadEquipmentFromCSV(lines) {
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line) {
            const values = line.split(',');
            const device = {
                id: Date.now().toString() + i,
                device_name: values[0] || '',
                device_type: values[1] || '',
                tag_prefix: values[3] || '',
                io_device: values[4] || '',
                protocol: 'modbus',
                modbusVariant: 'tcp',
                variables: [],
                alarms: [],
                trends: []
            };
            devices.push(device);
        }
    }

    saveDevicesToStorage();
    updateDeviceList();
    updateDeviceCounter();
}

function loadUnitsFromCSV(lines) {
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line) {
            const values = line.split(',');
            const existingDevice = devices.find(d => d.device_name === values[0]);

            if (existingDevice) {
                existingDevice.port_name = values[2] || '';
                existingDevice.device_ip = values[3] || '';
                existingDevice.protocol_name = values[4] || '';
                existingDevice.memory = values[5] || 'TRUE';
                existingDevice.unit_number = values[6] || '1';
            } else {
                const device = {
                    id: Date.now().toString() + i,
                    device_name: values[0] || '',
                    device_type: values[1] === 'IED' ? 'IED' : 'PLC',
                    port_name: values[2] || '',
                    device_ip: values[3] || '',
                    protocol_name: values[4] || '',
                    memory: values[5] || 'TRUE',
                    unit_number: values[6] || '1',
                    protocol: values[4] && values[4].includes('IEC') ? 'iec' : 'modbus',
                    modbusVariant: 'tcp',
                    variables: [],
                    alarms: [],
                    trends: []
                };
                devices.push(device);
            }
        }
    }

    saveDevicesToStorage();
    updateDeviceList();
    updateDeviceCounter();
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Device Configuration Generator - Schneider Electric</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .main-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: #3dcd68;
      color: white;
      padding: 20px;
    }

    .container {
      flex: 1;
      padding: 20px;
      background: white;
      margin: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header {
      margin-bottom: 30px;
    }

    .header h1 {
      color: #3dcd68;
      margin-bottom: 20px;
    }

    .config-section {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .config-section h3 {
      color: #3dcd68;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 20px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #3dcd68;
    }

    .config-cards {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
    }

    .config-card {
      flex: 1;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .config-card:hover {
      border-color: #3dcd68;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    }

    .config-card h4 {
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .config-card p {
      color: #666;
      font-size: 0.9rem;
      margin: 0;
    }

    .protocol-selection {
      background: #e8f5e8;
      border: 3px solid #3dcd68;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
      text-align: center;
    }

    .protocol-selection h2 {
      color: #2d7a3d;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 24px 0;
    }

    .protocol-buttons {
      display: flex;
      gap: 24px;
      justify-content: center;
      margin-top: 24px;
    }

    .protocol-btn {
      flex: 1;
      max-width: 200px;
      background: white;
      border: 3px solid #3dcd68;
      border-radius: 12px;
      padding: 24px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 600;
      color: #3dcd68;
    }

    .protocol-btn:hover {
      background: #3dcd68;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.25);
    }

    .protocol-btn.active {
      background: #3dcd68;
      color: white;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      position: relative;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-icon {
      width: 18px;
      height: 18px;
      background: #3dcd68;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: help;
      position: relative;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      background: #2db555;
    }

    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      max-width: 300px;
      min-width: 180px;
      white-space: normal;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      pointer-events: none;
      text-align: left;
      border: 1px solid #555;
      top: 25px;
      left: 50%;
      transform: translateX(-50%);
    }

    .tooltip::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #333;
    }

    .info-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    .hidden {
      display: none !important;
    }

    .file-input-label {
      display: inline-block;
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-right: 10px;
      font-weight: 600;
    }

    .file-input-label:hover {
      background: #0056b3;
    }

    .file-input {
      display: none;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-secondary {
      background: #007bff;
      color: white;
    }

    .btn-secondary:hover {
      background: #007bff;
    }

    .button-group {
      display: flex;
      gap: 16px;
      margin-top: 24px;
      align-items: center;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin: 24px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3dcd68, #28a745);
      width: 0%;
      transition: width 0.3s ease;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3dcd68;
      box-shadow: 0 0 0 3px rgba(61, 205, 104, 0.1);
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3dcd68;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active, .tab:hover {
      color: #3dcd68;
      border-bottom-color: #3dcd68;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .alert {
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .file-upload-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #e9ecef;
    }

    .file-upload-section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      .config-cards {
        flex-direction: column;
      }

      .protocol-buttons {
        flex-direction: column;
      }

      .form-grid-2, .form-grid-3 {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar">
      <h3>Saved Devices <span class="device-counter" id="deviceCounter">0</span></h3>
      <div class="device-list" id="deviceList">
        <div class="placeholder-content">
          <p>No devices configured yet.</p>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>Device Configuration Generator</h1>

          <div class="file-upload-section">
            <h3>File Upload</h3>
            <div>
              <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="loadCSV()" />
              <label for="csvFile" class="file-input-label"> Load CSV</label>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" onclick="showTab('device-info', event)">Device Info</button>
            <button class="tab" onclick="showTab('variables', event)">Variables</button>
            <button class="tab" onclick="showTab('alarms', event)">Alarms</button>
            <button class="tab" onclick="showTab('trends', event)">Trends</button>
          </div>
        </div>
      </div>

      <div class="tab-content active" id="device-info">
        <div class="protocol-selection">
          <h2>Select Communication Protocol</h2>
          <p>Choose the communication protocol that will be used for this device configuration</p>
          <div class="protocol-buttons">
            <button class="protocol-btn active" onclick="selectProtocol('modbus')">
              <div>Modbus</div>
            </button>
            <button class="protocol-btn" onclick="selectProtocol('iec')">
              <div>IEC</div>
            </button>
          </div>
        </div>

        <form id="deviceForm">
          <div class="config-cards">
            <div class="config-card" onclick="generateEquipmentConfig()">
              <h4>Equipment Config</h4>
              <p>Generate EQUIP.csv with device specifications</p>
            </div>
            <div class="config-card" onclick="generateUnitsConfig()">
              <h4>Units Config</h4>
              <p>Generate UNITS.csv with network settings</p>
            </div>
          </div>

          <div class="config-section">
            <h3>Device Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="device_name">
                  Device Name
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Enter a unique device name. Use only letters, numbers, and underscores. Example: PV_Panel_01, Wind_Turbine_A1
                    </div>
                  </div>
                </label>
                <input type="text" name="device_name" id="device_name" required placeholder="e.g. PV_Panel_01" />
              </div>

              <div class="form-group">
                <label for="device_type">
                  Device Type
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Select the device type from the list. This determines which variables and configurations will be available for this device.
                    </div>
                  </div>
                </label>
                <select name="device_type" id="device_type" required>
                  <option value="">Select device type</option>
                  <option value="PV">PV Panel</option>
                  <option value="WindTurbine">Wind Turbine</option>
                  <option value="FuelTurbine">Fuel Turbine</option>
                  <option value="FuelCell">Fuel Cell</option>
                  <option value="BESS">BESS</option>
                </select>
              </div>

              <div class="form-group">
                <label for="tag_prefix">
                  Tag Prefix
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Prefix used for all tags of this device. Should be short and unique. Example: FugaPV1, BESS01
                    </div>
                  </div>
                </label>
                <input type="text" name="tag_prefix" id="tag_prefix" required placeholder="e.g. FugaPV1" />
              </div>

              <div class="form-group">
                <label for="io_device">
                  I/O Device
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Name of the physical I/O device or inverter to which the device is connected. Example: Inverter_PV1
                    </div>
                  </div>
                </label>
                <input type="text" name="io_device" id="io_device" required placeholder="e.g. Inverter_PV1" />
              </div>
            </div>
          </div>

          <div class="config-section" id="modbus-config">
            <h3>Modbus Network Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="device_ip">
                  Device IP Address
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      IP address of the device on the network. Must be in IPv4 format (e.g. 192.168.1.100). Make sure the address is unique on the network.
                    </div>
                  </div>
                </label>
                <input type="text" name="device_ip" id="device_ip" required placeholder="e.g. 192.168.1.100" />
              </div>

              <div class="form-group">
                <label for="port_name">
                  Port Name
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Communication port name in the SCADA system. Optional field - leave empty if not using specific ports. Example: P14_BOARD1_PRJ3
                    </div>
                  </div>
                </label>
                <input type="text" name="port_name" id="port_name" placeholder="e.g. P14_BOARD1_PRJ3" />
              </div>

              <div class="form-group">
                <label for="unit_number">
                  Unit Number
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Unique unit number in the communication system (1-999). Used by communication protocols to identify the device.
                    </div>
                  </div>
                </label>
                <input type="number" name="unit_number" id="unit_number" required min="1" max="999" placeholder="e.g. 218" />
              </div>

              <div class="form-group">
                <label for="protocol">
                  Protocol
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Communication protocol used to connect to the device. Modbus TCP/IP for Ethernet communications.
                    </div>
                  </div>
                </label>
                <select name="protocol" id="protocol" required>
                  <option value="Modbus">Modbus TCP/IP</option>
                </select>
              </div>
            </div>
          </div>

          <div class="config-section hidden" id="iec-config">
            <h3>IEC 61850 Network Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="iec_device_ip">
                  Device IP Address
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      IP address of the IEC 61850 device. Must be in IPv4 format (e.g. 192.168.1.100). Ensure unique addressing on the substation network.
                    </div>
                  </div>
                </label>
                <input type="text" name="iec_device_ip" id="iec_device_ip" placeholder="e.g. 192.168.1.100" />
              </div>

              <div class="form-group">
                <label for="iec_port">
                  IEC Port
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      TCP port for IEC 61850 communication. Standard port is 102 for MMS services. Can be customized if needed.
                    </div>
                  </div>
                </label>
                <input type="number" name="iec_port" id="iec_port" placeholder="102" value="102" min="1" max="65535" />
              </div>

              <div class="form-group">
                <label for="ied_name">
                  IED Name
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Intelligent Electronic Device name as defined in the SCL configuration. Must match the IED name in the substation configuration file.
                    </div>
                  </div>
                </label>
                <input type="text" name="ied_name" id="ied_name" placeholder="e.g. PROT_RELAY_01" />
              </div>

              <div class="form-group">
                <label for="access_point">
                  Access Point
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Access Point name for the IED communication interface. Typically defined in the IED configuration (e.g. S1, AP1, ETH1).
                    </div>
                  </div>
                </label>
                <input type="text" name="access_point" id="access_point" placeholder="e.g. S1" />
              </div>

              <div class="form-group">
                <label for="logical_device">
                  Logical Device
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Logical Device name within the IED. Represents a logical grouping of functions (e.g. LD0, PROT, CTRL).
                    </div>
                  </div>
                </label>
                <input type="text" name="logical_device" id="logical_device" placeholder="e.g. LD0" />
              </div>

              <div class="form-group">
                <label for="report_control">
                  Report Control Block
                  <div class="info-icon">
                    i
                    <div class="tooltip">
                      Name of the Report Control Block (RCB) for data reporting. Used for unbuffered or buffered reporting of data changes and events.
                    </div>
                  </div>
                </label>
                <input type="text" name="report_control" id="report_control" placeholder="e.g. brcb01" />
              </div>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>

          <div class="button-group">
            <input type="file" id="cidFile" class="file-input hidden" accept=".cid" onchange="loadCID()" />
            <label for="cidFile" class="file-input-label hidden" id="cidInputLabel">Load CID</label>

            <button type="button" class="btn btn-success" onclick="saveDevice()">Save Device</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
            <button type="button" class="btn btn-primary" onclick="generateCSV()">Generate CSV Files</button>
          </div>
        </form>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Generating configuration files</p>
        </div>
      </div>

      <div class="tab-content" id="variables">
        <div class="config-section">
          <h3>Variable Configuration</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label for="variable_name">
                Variable Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Name of the process variable. Use descriptive names like ActivePower, Voltage, Temperature. No spaces or special characters.
                  </div>
                </div>
              </label>
              <input type="text" id="variable_name" placeholder="e.g. ActivePower" />
            </div>

            <div class="form-group">
              <label for="variable_type">
                Variable Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Variable type: Analog (continuous values), Digital (binary values 0/1)
                  </div>
                </div>
              </label>
              <select id="variable_type">
                <option value="analog">Analog</option>
                <option value="digital">Digital</option>
              </select>
            </div>

            <div class="form-group">
              <label for="data_type">
                Data Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Data type: Float (floating point numbers), Integer (whole numbers), Boolean (true/false), String (text).
                  </div>
                </div>
              </label>
              <select id="data_type">
                <option value="float">Float</option>
                <option value="int">Integer</option>
                <option value="bool">Boolean</option>
                <option value="string">String</option>
              </select>
            </div>

            <div class="form-group">
              <label for="unit">
                Unit
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Unit of measurement for the variable. Examples: kW, V, A, °C, Hz, %
                  </div>
                </div>
              </label>
              <input type="text" id="unit" placeholder="e.g. kW" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" onclick="addVariable()">Add Variable</button>
          </div>
        </div>

        <table class="variable-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Variable Name</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Type</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Data Type</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Unit</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Actions</th>
            </tr>
          </thead>
          <tbody id="variableTableBody">
          </tbody>
        </table>
      </div>

      <div class="tab-content" id="alarms">
        <div class="config-section">
          <h3>Alarms Configuration</h3>
          <div class="form-grid-3">
            <div class="form-group">
              <label for="alarm_name">
                Alarm Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Descriptive name for the alarm. Use clear naming convention like PowerFailure24V, HighTemperature, CommLoss
                  </div>
                </div>
              </label>
              <input type="text" id="alarm_name" placeholder="e.g. @(PowerFailure24V)" />
            </div>

            <div class="form-group">
              <label for="alarm_type">
                Alarm Type
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Alarm type: Analog (threshold-based), Digital (state-based), Advanced (complex logic)
                  </div>
                </div>
              </label>
              <select id="alarm_type">
                <option value="analog">Analog</option>
                <option value="digital">Digital</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>

            <div class="form-group">
              <label for="category">
                Category
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Priority level: Low (informational), Medium (warning), High (critical), Event (status change)
                  </div>
                </div>
              </label>
              <select id="category">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="event">Event</option>
              </select>
            </div>

            <div class="form-group">
              <label for="alarm_tag">
                Alarm Tag
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Tag name associated with the alarm. Links alarm to specific data point or signal.
                  </div>
                </div>
              </label>
              <input type="text" id="alarm_tag" placeholder="e.g. User_Event" />
            </div>

            <div class="form-group">
              <label for="equipment">
                Equipment
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Equipment hierarchy path. Defines where the alarm belongs in the system structure.
                  </div>
                </div>
              </label>
              <input type="text" id="equipment" placeholder="e.g. Virtual.System" />
            </div>

            <div class="form-group">
              <label for="item_name_alarm">
                Item Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Specific item or parameter name that triggers the alarm (e.g. CommHealth, Temperature, Voltage)
                  </div>
                </div>
              </label>
              <input type="text" id="item_name_alarm" placeholder="e.g. CommHealth" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" onclick="addAlarm()">Add Alarm</button>
          </div>
        </div>

        <table class="alarm-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Alarm Name</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Type</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Category</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Alarm Tag</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Equipment</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Item Name</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Actions</th>
            </tr>
          </thead>
          <tbody id="alarmTableBody">
          </tbody>
        </table>
      </div>

      <div class="tab-content" id="trends">
        <div class="config-section">
          <h3>Trends Configuration</h3>
          <div class="form-grid-2">
            <div class="form-group">
              <label for="tag_description">
                Tag Description
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Descriptive text for the trend tag. Should clearly identify what is being trended (e.g. "Phase A Current", "Active Power Output").
                  </div>
                </div>
              </label>
              <input type="text" id="tag_description" placeholder="e.g. Current A" />
            </div>

            <div class="form-group">
              <label for="trend_types">
                Trend Types
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Trend collection type: Event (on change), Periodic (time-based), Periodic-Event (both time and change based)
                  </div>
                </div>
              </label>
              <select id="trend_types">
                <option value="event">Event</option>
                <option value="periodic">Periodic</option>
                <option value="periodic-event">Periodic-Event</option>
              </select>
            </div>

            <div class="form-group">
              <label for="tag_name">
                Tag Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Full tag name path including logical node and data object (IEC 61850 format: MMXU1\A\phsA)
                  </div>
                </div>
              </label>
              <input type="text" id="tag_name" placeholder="e.g. MMXU1\A\phsA" />
            </div>

            <div class="form-group">
              <label for="item_name_trend">
                Item Name
                <div class="info-icon">
                  i
                  <div class="tooltip">
                    Short item identifier for the trending parameter (e.g. Ia, Vab, P, Q, F)
                  </div>
                </div>
              </label>
              <input type="text" id="item_name_trend" placeholder="e.g. Ia" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" onclick="addTrend()">Add Trend</button>
          </div>
        </div>

        <table class="trend-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Tag Description</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Trend Types</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Tag Name</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Item Name</th>
              <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Actions</th>
            </tr>
          </thead>
          <tbody id="trendTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let selectedProtocol = 'modbus';
    let devices = [];
    let variables = [];
    let alarms = [];
    let trends = [];
    let currentDevice = null;

    document.addEventListener('DOMContentLoaded', function() {
      selectProtocol('modbus');
      loadDevicesFromStorage();
      loadVariablesFromStorage();
      updateProgress();
      updateDeviceList();

      const cidFileInput = document.getElementById('cidFile');
      if (cidFileInput) {
        cidFileInput.addEventListener('change', loadCID);
      }
    });

    function showTab(tabName, event) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      document.getElementById(tabName).classList.add('active');

      if (event && event.target) {
        event.target.classList.add('active');
      }
    }

    function selectProtocol(protocol) {
      selectedProtocol = protocol;

      document.querySelectorAll('.protocol-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      if (event && event.target) {
        event.target.closest('.protocol-btn').classList.add('active');
      }

      const modbusConfig = document.getElementById('modbus-config');
      const iecConfig = document.getElementById('iec-config');
      const cidLabel = document.getElementById('cidInputLabel');
      const cidFile = document.getElementById('cidFile');

      if (protocol === 'modbus') {
        if (modbusConfig) modbusConfig.classList.remove('hidden');
        if (iecConfig) iecConfig.classList.add('hidden');

        if (cidLabel) cidLabel.classList.add('hidden');
        if (cidFile) cidFile.classList.add('hidden');

        const protocolSelect = document.getElementById('protocol');
        if (protocolSelect) {
          protocolSelect.innerHTML = '<option value="Modbus">Modbus TCP/IP</option>';
        }
      } else if (protocol === 'iec') {
        if (modbusConfig) modbusConfig.classList.add('hidden');
        if (iecConfig) iecConfig.classList.remove('hidden');

        if (cidLabel) cidLabel.classList.remove('hidden');
        if (cidFile) cidFile.classList.remove('hidden');

        const protocolSelect = document.getElementById('protocol');
        if (protocolSelect) {
          protocolSelect.innerHTML = '<option value="IEC61850">IEC 61850</option>';
        }
      }

      resetForm();
    }

    function loadCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split('\n');
        const headers = lines[0].split(',');

        if (lines.length > 1) {
          const data = lines[1].split(',');
          const form = document.getElementById('deviceForm');

          headers.forEach((header, index) => {
            const input = form.querySelector(`[name="${header.trim()}"]`);
            if (input && data[index]) {
              input.value = data[index].trim();
            }
          });

          updateProgress();
          showAlert('CSV loaded successfully!', 'success');
        }
      };
      reader.readAsText(file);
    }

    function loadCID() {
      const file = document.getElementById('cidFile').files[0];
      if (file) {
        console.log('Loading CID file:', file.name);
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            parseCIDFile(content);
          } catch (error) {
            console.error('Error parsing CID file:', error);
            showAlert('Error parsing CID file. Please check the file format.', 'error');
          }
        };
        reader.readAsText(file);
      }
    }

    function parseCIDFile(content) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(content, 'text/xml');

      const parserError = xmlDoc.getElementsByTagName('parsererror');
      if (parserError.length > 0) {
        throw new Error('Invalid XML format');
      }

      const ieds = xmlDoc.getElementsByTagName('IED');
      if (ieds.length > 0) {
        const ied = ieds[0];
        const iedName = ied.getAttribute('name');
        if (iedName) {
          const iedInput = document.getElementById('ied_name');
          if (iedInput) iedInput.value = iedName;
        }

        const accessPoints = ied.getElementsByTagName('AccessPoint');
        if (accessPoints.length > 0) {
          const ap = accessPoints[0];
          const apName = ap.getAttribute('name');
          if (apName) {
            const apInput = document.getElementById('access_point');
            if (apInput) apInput.value = apName;
          }

          const addresses = ap.getElementsByTagName('Address');
          if (addresses.length > 0) {
            const pTypes = addresses[0].getElementsByTagName('P');
            for (let i = 0; i < pTypes.length; i++) {
              if (pTypes[i].getAttribute('type') === 'IP') {
                const ipInput = document.getElementById('iec_device_ip');
                if (ipInput) ipInput.value = pTypes[i].textContent;
              }
            }
          }
        }

        const logicalDevices = ied.getElementsByTagName('LDevice');
        if (logicalDevices.length > 0) {
          const ldName = logicalDevices[0].getAttribute('inst');
          if (ldName) {
            const ldInput = document.getElementById('logical_device');
            if (ldInput) ldInput.value = ldName;
          }
        }

        const reportControls = xmlDoc.getElementsByTagName('ReportControl');
        if (reportControls.length > 0) {
          const rcName = reportControls[0].getAttribute('name');
          if (rcName) {
            const rcInput = document.getElementById('report_control');
            if (rcInput) rcInput.value = rcName;
          }
        }
      }

      console.log('CID file parsed successfully');
      showAlert('CID file loaded successfully!', 'success');
      updateProgress();
    }

    function resetForm() {
      const form = document.getElementById('deviceForm');
      if (form) {
        form.reset();
      }

      const csvFile = document.getElementById('csvFile');
      const cidFile = document.getElementById('cidFile');
      if (csvFile) csvFile.value = '';
      if (cidFile) cidFile.value = '';

      updateProgress();
    }

    function updateProgress() {
      const form = document.getElementById('deviceForm');
      if (!form) return;

      const inputs = form.querySelectorAll('input[required], select[required]');
      let filledInputs = 0;

      inputs.forEach(input => {
        if (input.value.trim() !== '') {
          filledInputs++;
        }
      });

      const progress = (filledInputs / inputs.length) * 100;
      const progressFill = document.querySelector('.progress-fill');
      if (progressFill) {
        progressFill.style.width = progress + '%';
      }
    }

    const deviceForm = document.getElementById('deviceForm');
    if (deviceForm) {
      deviceForm.addEventListener('input', updateProgress);
      deviceForm.addEventListener('change', updateProgress);
    }

    function saveDevice() {
      if (!validateForm()) return;

      const form = document.getElementById('deviceForm');
      const formData = new FormData(form);
      const device = {};

      for (let [key, value] of formData.entries()) {
        device[key] = value;
      }

      device.created_at = new Date().toISOString();
      device.id = Date.now().toString();
      device.protocol_type = selectedProtocol;

      devices.push(device);
      saveDevicesToStorage();
      updateDeviceList();
      showAlert('Device saved successfully!', 'success');
      resetForm();
    }

    function validateForm() {
      if (selectedProtocol === 'modbus') {
        return validateModbusForm();
      } else if (selectedProtocol === 'iec') {
        return validateIECForm();
      }
      return false;
    }

    function validateModbusForm() {
      const deviceName = document.getElementById('device_name');
      const deviceIP = document.getElementById('device_ip');
      const unitNumber = document.getElementById('unit_number');

      if (!deviceName || !deviceName.value.trim()) {
        showAlert('Please enter device name', 'error');
        return false;
      }

      if (!deviceIP || !deviceIP.value.trim()) {
        showAlert('Please enter device IP address', 'error');
        return false;
      }

      if (!unitNumber || !unitNumber.value.trim() || isNaN(unitNumber.value) || unitNumber.value < 1 || unitNumber.value > 999) {
        showAlert('Please enter valid unit number (1-999)', 'error');
        return false;
      }

      return true;
    }

    function validateIECForm() {
      const deviceName = document.getElementById('device_name');
      const iedName = document.getElementById('ied_name');
      const deviceIP = document.getElementById('iec_device_ip');

      if (!deviceName || !deviceName.value.trim()) {
        showAlert('Please enter device name', 'error');
        return false;
      }

      if (!iedName || !iedName.value.trim()) {
        showAlert('Please enter IED name', 'error');
        return false;
      }

      if (!deviceIP || !deviceIP.value.trim()) {
        showAlert('Please enter device IP address', 'error');
        return false;
      }

      return true;
    }

    function generateCSV() {
      if (devices.length === 0) {
        showAlert('No devices to export!', 'error');
        return;
      }

      showLoading();

      setTimeout(() => {
        const headers = ['device_name', 'device_type', 'tag_prefix', 'io_device', 'device_ip', 'port_name', 'unit_number', 'protocol'];
        let csv = headers.join(',') + '\n';

        devices.forEach(device => {
          const row = headers.map(header => device[header] || '').join(',');
          csv += row + '\n';
        });

        downloadCSV(csv, 'device_configuration.csv');

        if (variables.length > 0) {
          const varHeaders = ['variable_name', 'variable_type', 'data_type', 'unit'];
          let varCsv = varHeaders.join(',') + '\n';

          variables.forEach(variable => {
            const row = varHeaders.map(header => variable[header] || '').join(',');
            varCsv += row + '\n';
          });

          downloadCSV(varCsv, 'variable_configuration.csv');
        }

        hideLoading();
        showAlert('CSV files generated successfully!', 'success');
      }, 2000);
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function updateDeviceList() {
      const deviceList = document.getElementById('deviceList');
      if (!deviceList) return;

      deviceList.innerHTML = '';

      if (devices.length === 0) {
        deviceList.innerHTML = '<div class="placeholder-content"><p>No devices configured yet.</p></div>';
        return;
      }

      devices.forEach(device => {
        const deviceItem = document.createElement('div');
        deviceItem.className = 'device-item';
        deviceItem.innerHTML = `
          <div class="device-header">
            <span class="device-name">${device.device_name || 'Unnamed Device'}</span>
            <span class="device-type">${device.device_type || device.protocol_type || 'Unknown'}</span>
          </div>
          <div class="device-details">
            <div class="device-detail"><strong>IP:</strong> ${device.device_ip || device.iec_device_ip || 'N/A'}</div>
            <div class="device-detail"><strong>Protocol:</strong> ${device.protocol || device.protocol_type || 'Unknown'}</div>
            <div class="device-detail"><strong>Unit:</strong> ${device.unit_number || 'N/A'}</div>
            <div class="device-detail"><strong>Tag Prefix:</strong> ${device.tag_prefix || 'N/A'}</div>
          </div>
        `;
        deviceList.appendChild(deviceItem);
      });

      const counter = document.getElementById('deviceCounter');
      if (counter) {
        counter.textContent = devices.length;
      }
    }

    // Variables functions
    function addVariable() {
      const name = document.getElementById('variable_name').value;
      const type = document.getElementById('variable_type').value;
      const dataType = document.getElementById('data_type').value;
      const unit = document.getElementById('unit').value;

      if (!name.trim()) {
        showAlert('Please enter variable name', 'error');
        return;
      }

      const variable = {
        id: Date.now().toString(),
        variable_name: name,
        variable_type: type,
        data_type: dataType,
        unit: unit
      };

      variables.push(variable);
      updateVariableTable();
      clearVariableForm();
      showAlert('Variable added successfully!', 'success');
    }

    function updateVariableTable() {
      const tbody = document.getElementById('variableTableBody');
      tbody.innerHTML = '';

      variables.forEach(variable => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 12px; border: 1px solid #dee2e6;">${variable.variable_name}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${variable.variable_type}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${variable.data_type}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${variable.unit}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">
            <button class="btn btn-danger" onclick="removeVariable('${variable.id}')" style="background: #dc3545; padding: 6px 12px; font-size: 0.8rem;">Remove</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function removeVariable(id) {
      variables = variables.filter(v => v.id !== id);
      updateVariableTable();
      showAlert('Variable removed successfully!', 'success');
    }

    function clearVariableForm() {
      document.getElementById('variable_name').value = '';
      document.getElementById('variable_type').value = 'analog';
      document.getElementById('data_type').value = 'float';
      document.getElementById('unit').value = '';
    }

    // Alarms functions
    function addAlarm() {
      const name = document.getElementById('alarm_name').value;
      const type = document.getElementById('alarm_type').value;
      const category = document.getElementById('category').value;
      const tag = document.getElementById('alarm_tag').value;
      const equipment = document.getElementById('equipment').value;
      const itemName = document.getElementById('item_name_alarm').value;

      if (!name.trim()) {
        showAlert('Please enter alarm name', 'error');
        return;
      }

      const alarm = {
        id: Date.now().toString(),
        alarm_name: name,
        alarm_type: type,
        category: category,
        alarm_tag: tag,
        equipment: equipment,
        item_name: itemName
      };

      alarms.push(alarm);
      updateAlarmTable();
      clearAlarmForm();
      showAlert('Alarm added successfully!', 'success');
    }

    function updateAlarmTable() {
      const tbody = document.getElementById('alarmTableBody');
      tbody.innerHTML = '';

      alarms.forEach(alarm => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 12px; border: 1px solid #dee2e6;">${alarm.alarm_name}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${alarm.alarm_type}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${alarm.category}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${alarm.alarm_tag}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${alarm.equipment}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${alarm.item_name}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">
            <button class="btn btn-danger" onclick="removeAlarm('${alarm.id}')" style="background: #dc3545; padding: 6px 12px; font-size: 0.8rem;">Remove</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function removeAlarm(id) {
      alarms = alarms.filter(a => a.id !== id);
      updateAlarmTable();
      showAlert('Alarm removed successfully!', 'success');
    }

    function clearAlarmForm() {
      document.getElementById('alarm_name').value = '';
      document.getElementById('alarm_type').value = 'analog';
      document.getElementById('category').value = 'low';
      document.getElementById('alarm_tag').value = '';
      document.getElementById('equipment').value = '';
      document.getElementById('item_name_alarm').value = '';
    }


    function addTrend() {
      const description = document.getElementById('tag_description').value;
      const type = document.getElementById('trend_types').value;
      const tagName = document.getElementById('tag_name').value;
      const itemName = document.getElementById('item_name_trend').value;

      if (!description.trim()) {
        showAlert('Please enter tag description', 'error');
        return;
      }

      const trend = {
        id: Date.now().toString(),
        tag_description: description,
        trend_types: type,
        tag_name: tagName,
        item_name: itemName
      };

      trends.push(trend);
      updateTrendTable();
      clearTrendForm();
      showAlert('Trend added successfully!', 'success');
    }

    function updateTrendTable() {
      const tbody = document.getElementById('trendTableBody');
      tbody.innerHTML = '';

      trends.forEach(trend => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding: 12px; border: 1px solid #dee2e6;">${trend.tag_description}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${trend.trend_types}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${trend.tag_name}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">${trend.item_name}</td>
          <td style="padding: 12px; border: 1px solid #dee2e6;">
            <button class="btn btn-danger" onclick="removeTrend('${trend.id}')" style="background: #dc3545; padding: 6px 12px; font-size: 0.8rem;">Remove</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function removeTrend(id) {
      trends = trends.filter(t => t.id !== id);
      updateTrendTable();
      showAlert('Trend removed successfully!', 'success');
    }

    function clearTrendForm() {
      document.getElementById('tag_description').value = '';
      document.getElementById('trend_types').value = 'event';
      document.getElementById('tag_name').value = '';
      document.getElementById('item_name_trend').value = '';
    }

    function saveDevicesToStorage() {
      console.log('Saving devices to storage:', devices);
    }

    function loadDevicesFromStorage() {
      console.log('Loading devices from storage');
    }

    function saveVariablesToStorage() {
      console.log('Saving variables to storage:', variables);
    }

    function loadVariablesFromStorage() {
      console.log('Loading variables from storage');
    }

    function showLoading() {
      const loading = document.getElementById('loading');
      if (loading) loading.classList.add('show');
    }

    function hideLoading() {
      const loading = document.getElementById('loading');
      if (loading) loading.classList.remove('show');
    }

    function showAlert(message, type) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;

      const container = document.querySelector('.tab-content.active') || document.body;
      container.insertBefore(alert, container.firstChild);

      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    function generateEquipmentConfig() {
      showAlert('Equipment config generation would be implemented here', 'success');
    }

    function generateUnitsConfig() {
      showAlert('Units config generation would be implemented here', 'success');
    }

    const deviceIPInput = document.getElementById('device_ip');
    const iecIPInput = document.getElementById('iec_device_ip');

    function validateIPAddress(input) {
      if (!input) return;

      input.addEventListener('blur', function () {
        const ip = this.value;
        const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;

        if (ip && !ipPattern.test(ip)) {
          showAlert('Please enter a valid IP address!', 'error');
          this.focus();
        }
      });
    }

    validateIPAddress(deviceIPInput);
    validateIPAddress(iecIPInput);

    function submitForm() {
      if (validateForm()) {
        saveDevice();
        return true;
      }
      return false;
    }
  </script>
</body>
</html>
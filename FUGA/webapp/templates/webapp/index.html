{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Device Configuration Generator - Schneider Electric</title>
  <link rel="stylesheet" href="{% static 'webapp/css/style.css' %}">
  <style>
    .config-section {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .config-section h3 {
      color: #3dcd68;
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 20px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #3dcd68;
    }

    .config-cards {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
    }

    .config-card {
      flex: 1;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .config-card:hover {
      border-color: #3dcd68;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
    }

    .config-card h4 {
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .config-card p {
      color: #666;
      font-size: 0.9rem;
      margin: 0;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }


    .form-group {
      position: relative;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-icon {
      width: 18px;
      height: 18px;
      background: #3dcd68;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: help;
      position: relative;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      background: #2db555;
    }

    .tooltip {
      position: fixed;
      background: #333;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      max-width: 300px;
      min-width: 180px;
      white-space: normal;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      pointer-events: none;
      text-align: left;
      border: 1px solid #555;
    }

    .tooltip::after {
      content: '';
      position: absolute;
      border: 8px solid transparent;
    }


    .tooltip.tooltip-bottom-right::after {
      top: -16px;
      left: 20px;
      border-bottom-color: #333;
    }


    .tooltip.tooltip-bottom-left::after {
      top: -16px;
      right: 20px;
      border-bottom-color: #333;
    }


    .tooltip.tooltip-top-right::after {
      bottom: -16px;
      left: 20px;
      border-top-color: #333;
    }


    .tooltip.tooltip-top-left::after {
      bottom: -16px;
      right: 20px;
      border-top-color: #333;
    }


    .tooltip.tooltip-right::after {
      top: 20px;
      left: -16px;
      border-right-color: #333;
    }


    .tooltip.tooltip-left::after {
      top: 20px;
      right: -16px;
      border-left-color: #333;
    }

    .info-icon.active .tooltip,
    .info-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    @media (max-width: 768px) {
      .config-cards {
        flex-direction: column;
      }

      .form-grid-2 {
        grid-template-columns: 1fr;
      }

      .tooltip {
        max-width: 280px;
        min-width: 180px;
      }
    }
  </style>
</head>
<body>
  <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">☰</button>

  <div class="logo-container">
    <img src="{% static 'webapp/images/schneider-logo.png' %}" alt="Schneider Logo" />
  </div>

  <div class="main-container">
    <div class="sidebar" id="sidebar">
      <h3>Saved Devices <span class="device-counter" id="deviceCounter">0</span></h3>
      <ul class="device-tree" id="deviceTree">
        <div class="empty-state">
          <h4>No devices saved</h4>
          <p>Add your first device to see it here</p>
        </div>
      </ul>
    </div>

    <div class="container">
      <div class="header">
        <div class="header-content">
          <h1>Device Configuration Generator</h1>
          <div class="tabs">
            <button class="tab active" onclick="showTab('device-info', event)">Device Info</button>
            <button class="tab" onclick="showTab('variables', event)">Variables</button>
            <button class="tab" onclick="showTab('alarms', event)">Alarms</button>
            <button class="tab" onclick="showTab('trends', event)">Trends</button>
          </div>
        </div>
      </div>

      <div class="tab-content active" id="device-info">
        <form id="deviceForm">
          <div class="config-cards">
            <div class="config-card" onclick="generateEquipmentConfig()">
              <h4>Equipment Config</h4>
              <p>Generate EQUIP.csv with device specifications</p>
            </div>
            <div class="config-card" onclick="generateUnitsConfig()">
              <h4>Units Config</h4>
              <p>Generate UNITS.csv with network settings</p>
            </div>
          </div>

          <div class="config-section">
            <h3>Device Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="device_name">
                  Device Name
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      Enter a unique device name. Use only letters, numbers, and underscores. Example: Solar_Panel_01, Wind_Turbine_A1
                    </div>
                  </div>
                </label>
                <input type="text" name="device_name" id="device_name" required placeholder="e.g. Solar_Panel_01" />
              </div>

              <div class="form-group">
                <label for="device_type">
                  Device Type
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      Select the device type from the list. This determines which variables and configurations will be available for this device.
                    </div>
                  </div>
                </label>
                <select name="device_type" id="device_type" required>
                  <option value="">Select device type</option>
                  <option value="PV">Solar Panel</option>
                  <option value="WindTurbine">Wind Turbine</option>
                  <option value="FuelTurbine">Fuel Turbine</option>
                  <option value="FuelCell">Fuel Cell</option>
                  <option value="BESS">BESS</option>
                </select>
              </div>

              <div class="form-group">
                <label for="tag_prefix">
                  Tag Prefix
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      Prefix used for all tags of this device. Should be short and unique. Example: FugaPV1, WT_A1, BESS01
                    </div>
                  </div>
                </label>
                <input type="text" name="tag_prefix" id="tag_prefix" required placeholder="e.g. FugaPV1" />
              </div>

              <div class="form-group">
                <label for="io_device">
                  I/O Device
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      Name of the physical I/O device or inverter to which the device is connected. Example: Inverter_PV1, ModbusGateway_01
                    </div>
                  </div>
                </label>
                <input type="text" name="io_device" id="io_device" required placeholder="e.g. Inverter_PV1" />
              </div>
            </div>
          </div>

          <div class="config-section">
            <h3>Network Configuration</h3>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="device_ip">
                  Device IP Address
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      IP address of the device on the network. Must be in IPv4 format (e.g. 192.168.1.100). Make sure the address is unique on the network.
                    </div>
                  </div>
                </label>
                <input type="text" name="device_ip" id="device_ip" required placeholder="e.g. 192.168.1.100" />
              </div>

              <div class="form-group">
                <label for="port_name">
                  Port Name
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      Communication port name in the SCADA system. Optional field - leave empty if not using specific ports. Example: P14_BOARD1_PRJ3
                    </div>
                  </div>
                </label>
                <input type="text" name="port_name" id="port_name" placeholder="e.g. P14_BOARD1_PRJ3" />
              </div>

              <div class="form-group">
                <label for="unit_number">
                  Unit Number
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      Unique unit number in the communication system (1-999). Used by communication protocols to identify the device.
                    </div>
                  </div>
                </label>
                <input type="number" name="unit_number" id="unit_number" required min="1" max="999" placeholder="e.g. 218" />
              </div>

              <div class="form-group">
                <label for="protocol">
                  Protocol
                  <div class="info-icon" onclick="toggleTooltip(event, this)">
                    i
                    <div class="tooltip">
                      Communication protocol used to connect to the device. IEC61850N for modern devices, Modbus for legacy systems.
                    </div>
                  </div>
                </label>
                <select name="protocol" id="protocol" required>
                  <option value="IEC61850N">IEC61850N</option>
                  <option value="Modbus">Modbus</option>
                </select>
              </div>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>

          <div class="button-group">
            <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="loadCSV()" />
            <label for="csvFile" class="file-input-label">Load CSV</label>
            <button type="button" class="btn btn-success" onclick="saveDevice()">Save Device</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
            <button type="button" class="btn btn-primary" onclick="generateCSV()">Generate CSV Files</button>
          </div>
        </form>
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Generating configuration files...</p>
        </div>
      </div>

      <div class="tab-content" id="variables">
        <div class="form-section">
          <h3>Variable Configuration</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="variable_name">
                Variable Name
                <div class="info-icon" onclick="toggleTooltip(event, this)">
                  i
                  <div class="tooltip">
                    Name of the process variable. Use descriptive names like ActivePower, Voltage, Temperature. No spaces or special characters.
                  </div>
                </div>
              </label>
              <input type="text" id="variable_name" placeholder="e.g. ActivePower" />
            </div>

            <div class="form-group">
              <label for="variable_type">
                Variable Type
                <div class="info-icon" onclick="toggleTooltip(event, this)">
                  i
                  <div class="tooltip">
                    Variable type: Analog (continuous values), Digital (binary values 0/1), Calculated (computed based on other variables).
                  </div>
                </div>
              </label>
              <select id="variable_type">
                <option value="analog">Analog</option>
                <option value="digital">Digital</option>
                <option value="calculated">Calculated</option>
              </select>
            </div>

            <div class="form-group">
              <label for="data_type">
                Data Type
                <div class="info-icon" onclick="toggleTooltip(event, this)">
                  i
                  <div class="tooltip">
                    Data type: Float (floating point numbers), Integer (whole numbers), Boolean (true/false), String (text).
                  </div>
                </div>
              </label>
              <select id="data_type">
                <option value="float">Float</option>
                <option value="int">Integer</option>
                <option value="bool">Boolean</option>
                <option value="string">String</option>
              </select>
            </div>

            <div class="form-group">
              <label for="unit">
                Unit
                <div class="info-icon" onclick="toggleTooltip(event, this)">
                  i
                  <div class="tooltip">
                    Unit of measurement for the variable. Examples: kW, V, A, °C, %, Hz. Leave empty for dimensionless variables.
                  </div>
                </div>
              </label>
              <input type="text" id="unit" placeholder="e.g. kW" />
            </div>
          </div>
          <div class="button-group">
            <button class="btn btn-primary" onclick="addVariable()">Add Variable</button>
          </div>
        </div>

        <table class="variable-table">
          <thead>
            <tr>
              <th>Variable Name</th>
              <th>Type</th>
              <th>Data Type</th>
              <th>Unit</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="variableTableBody"></tbody>
        </table>
      </div>

      <div class="tab-content" id="devices">
        <div class="form-section">
          <h3>Device Management</h3>
          <p>Manage all configured devices and their settings</p>
          <div class="device-list" id="deviceList"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'webapp/js/script.js' %}"></script>
  <script>
    function toggleTooltip(event, element) {
      event.stopPropagation();


      document.querySelectorAll('.info-icon.active').forEach(icon => {
        if (icon !== element) {
          icon.classList.remove('active');
        }
      });


      element.classList.toggle('active');


      if (element.classList.contains('active')) {
        positionTooltip(element);
      }
    }

    function positionTooltip(iconElement) {
      const tooltip = iconElement.querySelector('.tooltip');
      const rect = iconElement.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const tooltipWidth = 300;
      const tooltipHeight = 80;
      const margin = 15;


      tooltip.className = 'tooltip';

      let left, top;
      let positionClass = '';


      if (rect.bottom + tooltipHeight + margin < viewportHeight &&
          rect.left + tooltipWidth + margin < viewportWidth) {
        left = rect.left;
        top = rect.bottom + margin;
        positionClass = 'tooltip-bottom-right';
      }

      else if (rect.bottom + tooltipHeight + margin < viewportHeight &&
               rect.right - tooltipWidth - margin > 0) {
        left = rect.right - tooltipWidth;
        top = rect.bottom + margin;
        positionClass = 'tooltip-bottom-left';
      }

      else if (rect.top - tooltipHeight - margin > 0 &&
               rect.left + tooltipWidth + margin < viewportWidth) {
        left = rect.left;
        top = rect.top - tooltipHeight - margin;
        positionClass = 'tooltip-top-right';
      }

      else if (rect.top - tooltipHeight - margin > 0 &&
               rect.right - tooltipWidth - margin > 0) {
        left = rect.right - tooltipWidth;
        top = rect.top - tooltipHeight - margin;
        positionClass = 'tooltip-top-left';
      }
      else if (rect.right + tooltipWidth + margin < viewportWidth) {
        left = rect.right + margin;
        top = Math.max(margin, rect.top - tooltipHeight/2);

        if (top + tooltipHeight > viewportHeight - margin) {
          top = viewportHeight - tooltipHeight - margin;
        }
        positionClass = 'tooltip-right';
      }

      else if (rect.left - tooltipWidth - margin > 0) {
        left = rect.left - tooltipWidth - margin;
        top = Math.max(margin, rect.top - tooltipHeight/2);
        // Make sure it doesn't go below viewport
        if (top + tooltipHeight > viewportHeight - margin) {
          top = viewportHeight - tooltipHeight - margin;
        }
        positionClass = 'tooltip-left';
      }

      else {
        left = (viewportWidth - tooltipWidth) / 2;
        top = (viewportHeight - tooltipHeight) / 2;
        positionClass = 'tooltip-bottom-right';
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
      tooltip.classList.add(positionClass);
    }


    document.addEventListener('click', function(event) {
      if (!event.target.closest('.info-icon')) {
        document.querySelectorAll('.info-icon.active').forEach(icon => {
          icon.classList.remove('active');
        });
      }
    });


    window.addEventListener('resize', function() {
      document.querySelectorAll('.info-icon.active').forEach(icon => {
        positionTooltip(icon);
      });
    });

    function generateEquipmentConfig() {
      console.log('Generating Equipment Config...');
    }

    function generateUnitsConfig() {
      console.log('Generating Units Config...');
    }
  </script>
</body>
</html>